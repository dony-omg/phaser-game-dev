"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[655],{143:(t,e,i)=>{i.r(e),i.d(e,{endGameSession:()=>x,fetchGameList:()=>m,startGameSession:()=>p,submitAnswer:()=>f});var s,a=i(2408);i(5364);let n=((s="https://dev-api.apex-academy.kyanon.dev",void 0!==s)?s:"").replace(/\/$/,""),r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjMyMDI4N2Y1LWU3NTktNGNlNy1hODZmLWI5NTRkOTU5ZmViMSIsImVtYWlsIjoidGhhbmguZGFvQGt5YW5vbi5kaWdpdGFsIiwiaWF0IjoxNzY3Njg5ODIyLCJleHAiOjE3NzAyODE4MjIsImlzcyI6IkRldkFwZXhBY2FkIn0.bSjUGFkIT87qkij2jobMVw-ZyRYRAUppRdoLTUZsl_o",o={id:"session_mock_001",game_id:"game_mock_001",game_session_questions:[{id:"q_1",order:1,is_answered:!1,question_id:"question_1"},{id:"q_2",order:2,is_answered:!1,question_id:"question_2"},{id:"q_3",order:3,is_answered:!1,question_id:"question_3"}],game:{code:"vocab_race",time_limit:180}},l=[{session_question_id:"q_1",question:{content:"Thủ đ\xf4 của Việt Nam l\xe0 g\xec?",options:[{id:"q_1_o_1",text:"H\xe0 Nội",is_correct:!0},{id:"q_1_o_2",text:"Đ\xe0 Nẵng",is_correct:!1},{id:"q_1_o_3",text:"Hải Ph\xf2ng",is_correct:!1},{id:"q_1_o_4",text:"Cần Thơ",is_correct:!1}]}},{session_question_id:"q_2",question:{content:"Phaser sử dụng ng\xf4n ngữ n\xe0o?",options:[{id:"q_2_o_1",text:"TypeScript/JavaScript",is_correct:!0},{id:"q_2_o_2",text:"C#",is_correct:!1},{id:"q_2_o_3",text:"Python",is_correct:!1},{id:"q_2_o_4",text:"Go",is_correct:!1}]}},{session_question_id:"q_3",question:{content:"Chọn từ tr\xe1i nghĩa của “fast”.",options:[{id:"q_3_o_1",text:"slow",is_correct:!0},{id:"q_3_o_2",text:"far",is_correct:!1},{id:"q_3_o_3",text:"high",is_correct:!1},{id:"q_3_o_4",text:"small",is_correct:!1}]}}],h=t=>new Promise(e=>setTimeout(e,t));function d(t){return(null==t||!t.forceReal)&&(0,a.IG)()}async function c(t,e){var i,s,a,o,l;let h=function(){if(!n)throw Error("Missing NEXT_PUBLIC_API_URL (or VITE_API_URL)");return n}(),d={Authorization:"Bearer ".concat(r)};console.log("[API][HTTP] request",{url:"".concat(h).concat(t),method:null!=(i=null==e?void 0:e.method)?i:"GET",hasAuthToken:!!d.Authorization,authSource:"env_debug_token"}),console.error("[API][HTTP] request-visible","".concat(null!=(s=null==e?void 0:e.method)?s:"GET"," ").concat(h).concat(t));let c=await fetch("".concat(h).concat(t),{method:null!=(a=null==e?void 0:e.method)?a:"GET",headers:{"Content-Type":"application/json",...d,...null!=(o=null==e?void 0:e.headers)?o:{}},...e});if(!c.ok)throw Error("HTTP error! status: ".concat(c.status));let u=await c.json();if(!(null==u?void 0:u.success))throw Error(null!=(l=null==u?void 0:u.message)?l:"API response was not successful");return u}async function u(t,e){try{let i=await c("/api/v1/game/".concat(t,"/question/").concat(e));return{session_question_id:i.data.id,question:{content:i.data.question.content,options:i.data.question.options.map(t=>({id:t.id,text:t.text,is_correct:t.is_correct}))}}}catch(t){return console.error("fetchQuestionDetail failed",t),null}}async function g(t,e){let i=await u(t,e.id);if(i)return i;if(e.question_id&&e.question_id!==e.id){let i=await u(t,e.question_id);if(i)return i}return console.error("[API][REAL] Cannot resolve question detail from both ids",{sessionId:t,sessionQuestionId:e.id,questionId:e.question_id}),null}async function p(t,e){var i;if(console.log("[API] startGameSession invoked",{gameCode:t,forceReal:!!(null==e?void 0:e.forceReal),mockMode:(0,a.IG)()}),d(e))return await h(200),console.log("[API][MOCK] startGameSession",{gameCode:t,sessionId:o.id,gameId:o.game_id,questionCount:l.length}),{success:!0,message:"Mock start for ".concat(t),data:{...o,questions:l}};let s=await c("/api/v1/game/start-game",{method:"POST",body:JSON.stringify({game_code:"train_game"===t||"train"===t?"trains_cars":"tower"===t?"vocab_race":t})}),n=s.data.id,r=null!=(i=s.data.game_session_questions)?i:[],u=(await Promise.all(r.sort((t,e)=>t.order-e.order).map(t=>g(n,t)))).filter(t=>null!==t);if(0===u.length)throw Error("No question details resolved from real API");return{...s,data:{...s.data,questions:u}}}async function m(t){return d(t)?(await h(120),{success:!0,message:"Mock game list",data:[{id:"mock_town",code:"vocab_race",name:"Town",is_accessible:!0},{id:"mock_train",code:"trains_cars",name:"Train",is_accessible:!0}]}):c("/api/v1/game/list-game")}async function f(t,e,i,s){return d(s)?(await h(120),console.log("[API][MOCK] submitAnswer",{sessionId:t,sessionQuestionId:e,answerId:i}),{success:!0,message:"Mock answer submitted",data:{remain_sec:0,is_end_game:!1,is_win:!1,is_lose:!1,is_correct:!0,is_answered:!0,session:{id:t,score:0,current_question:0}}}):c("/api/v1/game/answer",{method:"POST",body:JSON.stringify({session_id:t,question_id:e,answer_id:i})})}async function x(t,e,i){return d(i)?(await h(150),console.log("[API][MOCK] endGameSession",{gameId:t,score:e}),{success:!0,message:"Mock end for ".concat(t," with score ").concat(e),data:{ok:!0}}):c("/api/v1/game/answer-batching",{method:"POST",body:JSON.stringify({game_id:t,score:e})})}},2408:(t,e,i)=>{i.d(e,{IG:()=>l,MU:()=>r,YY:()=>n,n6:()=>o});let s="debug_api_mode",a="real";function n(){let t=window.localStorage.getItem(s);return"mock"===t||"real"===t?t:a}function r(t){window.localStorage.setItem(s,t)}function o(){return a}function l(){return"mock"===n()}},3655:(t,e,i)=>{i.r(e),i.d(e,{default:()=>C});var s=i(7876),a=i(4232),n=i(8362),r=i.n(n);let o={vocab_race:{code:"vocab_race",label:"Tower",mapKey:"bg-tower",mapPath:"maps/bg 2.png",assetRoot:"games/tower",backgroundColor:4174824,useTexturePath:!0},train_game:{code:"train_game",label:"Nối Đu\xf4i Xe Lửa",mapKey:"bg-train",mapPath:"background copy 2.png",assetRoot:"games/train",backgroundColor:0xf59e0b,useTexturePath:!1}},l="vocab_race";function h(t){return t?"tower"===t?"vocab_race":"train"===t?"train_game":t in o?t:l:l}function d(t){return o[h(t)]}class c extends n.Scene{preload(){let t=d(this.registry.get("gameCode")),e=t.assetRoot;if(this.load.setPath("/assets"),"train_game"===t.code){let t="".concat(e,"/background.png");this.load.image("bg-1",t),this.load.image("bg-2",t),this.load.image("bg-3",t),this.load.image("bg-4",t),this.load.image("bg-5",t),this.load.image("bg-6",t),this.load.image("logo","".concat(e,"/background.png"))}else this.load.image("bg-1","".concat(e,"/backgrounds/1.png")),this.load.image("bg-2","".concat(e,"/backgrounds/2.png")),this.load.image("bg-3","".concat(e,"/backgrounds/3.png")),this.load.image("bg-4","".concat(e,"/backgrounds/4.png")),this.load.image("bg-5","".concat(e,"/backgrounds/5.png")),this.load.image("bg-6","".concat(e,"/backgrounds/6.png")),this.load.image("logo","".concat(e,"/ui/logo.png"))}create(){this.scene.start("Preloader")}constructor(){super("Boot")}}let u=new n.Events.EventEmitter;var g=i(143);class p extends n.Scene{init(t){this.dataPayload=t}create(){let{width:t,height:e}=this.scale,i=d(h(this.registry.get("gameCode"))),{gameId:s,score:a,bonus:n,result:r,reason:o}=this.dataPayload||{gameId:null,score:0,bonus:0,result:"lose",reason:""};s&&(0,g.endGameSession)(s,a).catch(t=>{console.error("endGameSession failed",t)}),this.camera=this.cameras.main,this.camera.setBackgroundColor("win"===r?1483594:0xdc2626),this.background=this.add.image(t/2,e/2,i.mapKey),this.background.setAlpha(.5),this.gameOverText=this.add.text(t/2,220,"win"===r?"Chiến Thắng!":"Hết Giờ",{fontFamily:"Arial Black",fontSize:64,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5).setDepth(100),this.detailText=this.add.text(t/2,340,"Điểm: ".concat(a," ").concat(n>0?"(+".concat(n," thưởng)"):"","\n").concat(o),{fontFamily:"Arial",fontSize:26,color:"#e2e8f0",align:"center"}).setOrigin(.5).setDepth(100),this.restartButton=this.createButton(t/2,520,"Chơi lại"),u.emit("current-scene-ready",this)}createButton(t,e,i){let s=this.add.container(t,e),a=this.add.rectangle(0,0,240,56,2042167).setStrokeStyle(2,0xfbbf24),n=this.add.text(0,0,i,{fontFamily:"Arial Black",fontSize:24,color:"#f8fafc"}).setOrigin(.5);return s.add([a,n]),s.setSize(240,56),s.setInteractive(new Phaser.Geom.Rectangle(-120,-28,240,56),Phaser.Geom.Rectangle.Contains),s.on("pointerover",()=>a.setFillStyle(3359061)),s.on("pointerout",()=>a.setFillStyle(2042167)),s.on("pointerdown",()=>this.changeScene()),s}changeScene(){let t=h(this.registry.get("gameCode"));this.scene.start("MainMenu",{gameCode:t})}constructor(){super("GameOver")}}class m{getContainer(){return this.container}get x(){return this.container.x}get y(){return this.container.y}setPosition(t,e){this.container.setPosition(t,e)}setState(t){var e;this.currentState=t;let i=this.isFlipped?"emote-tran-idle-flipped":"emote-tran-idle",s=this.isFlipped?"emote-tran-correct-flipped":"emote-tran-correct",a=this.isFlipped?"emote-tran-incorrect-flipped":"emote-tran-incorrect";null==(e=this.characterSprite.anims)||e.stop(),this.characterSprite.setScale(this.spriteScale),this.characterSprite.setTexture({idle:i,correct:s,incorrect:a}[t]),this.characterSprite.setFlipX(!1)}getState(){return this.currentState}flip(t){if(this.isFlipped=!t,"idle"===this.currentState)return void this.setState("idle");this.setState(this.currentState)}jumpTo(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:600;return new Promise(s=>{var a;this.stateResetTimer&&(this.stateResetTimer.remove(!1),this.stateResetTimer=void 0),this.scene.tweens.killTweensOf(this.characterSprite);let n=t>this.container.x;!n!==this.isFlipped&&this.flip(n),null==(a=this.characterSprite.anims)||a.stop(),this.characterSprite.setTexture("character"),this.characterSprite.setScale(this.jumpScale),this.characterSprite.setFlipX(this.isFlipped),this.characterSprite.y=0,this.characterSprite.play("tran-jump",!0),this.scene.tweens.add({targets:this.shadowSprite,alpha:0,scaleX:.5,scaleY:.5,duration:.3*i});let r=this.container.x,o=this.container.y,l=Phaser.Math.Distance.Between(r,o,t,e),h=Phaser.Math.Clamp(.35*l,80,180);this.scene.tweens.add({targets:this.container,x:t,duration:i,ease:"Sine.easeInOut",onUpdate:t=>{let i=t.progress,s=Phaser.Math.Linear(o,e,i),a=Math.sin(Math.PI*i)*h;this.container.y=s-a},onComplete:()=>{var t;this.scene.tweens.killTweensOf(this.characterSprite),this.characterSprite.setScale(this.spriteScale),null==(t=this.characterSprite.anims)||t.stop(),this.setState("idle"),s()}}),this.scene.tweens.add({targets:this.characterSprite,scaleX:.95*this.jumpScale,scaleY:1.08*this.jumpScale,duration:.5*i,yoyo:!0,ease:"Sine.easeInOut"}),this.characterSprite.y=0,this.scene.tweens.add({targets:this.shadowSprite,alpha:this.shadowAlpha,scaleX:1,scaleY:1,duration:.3*i,delay:.7*i})})}playIdle(){this.scene.tweens.add({targets:this.characterSprite,y:-10,duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}stopIdle(){this.scene.tweens.killTweensOf(this.characterSprite),this.characterSprite.y=0}showCorrect(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this.stateResetTimer&&(this.stateResetTimer.remove(!1),this.stateResetTimer=void 0),this.setState("correct"),this.scene.tweens.add({targets:this.characterSprite,scale:1.2*this.spriteScale,duration:200,yoyo:!0}),this.stateResetTimer=this.scene.time.delayedCall(t,()=>{this.setState("idle"),this.stateResetTimer=void 0})}showIncorrect(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this.stateResetTimer&&(this.stateResetTimer.remove(!1),this.stateResetTimer=void 0),this.setState("incorrect"),this.scene.tweens.add({targets:this.container,x:this.container.x+5,duration:50,yoyo:!0,repeat:5}),this.stateResetTimer=this.scene.time.delayedCall(t,()=>{this.setState("idle"),this.stateResetTimer=void 0})}isJumping(){return this.scene.tweens.getTweensOf(this.container).length>0}constructor(t,e,i){this.currentState="idle",this.isFlipped=!1,this.spriteScale=.16,this.shadowAlpha=.3,this.jumpScale=.36,this.scene=t,this.container=t.add.container(e,i),this.shadowSprite=t.add.ellipse(0,60,120,30,0,this.shadowAlpha),this.container.add(this.shadowSprite),this.characterSprite=t.add.sprite(0,0,"emote-tran-idle"),this.characterSprite.setScale(this.spriteScale),this.container.add(this.characterSprite)}}class f{setVisible(t){this.container.setVisible(t)}setAlpha(t){this.container.setAlpha(t)}setInteractive(t){this.optionButtons.forEach(e=>{let i=e.getData("hit");i&&(t?i.setInteractive():i.disableInteractive())})}onOptionSelected(t){this.optionButtons.forEach((e,i)=>{let s=e.getData("hit");s&&(s.removeAllListeners("pointerdown"),s.on("pointerdown",()=>t(i)))})}setQuestion(t){this.showIndex&&t.index&&t.total?(this.indexText.setText("Question ".concat(t.index,"/").concat(t.total)),this.indexText.setAlpha(1)):this.indexText.setAlpha(0);let e=t.question.length>55?"".concat(t.question.slice(0,54),"…"):t.question;this.questionText.setText(e),this.optionButtons.forEach((e,i)=>{var s;let a=e.getData("redraw"),n=e.getData("text");a("normal"),n.setFontSize(20),n.setText("".concat(null!=(s=t.options[i])?s:"")),n.width>520&&n.setFontSize(18),n.width>560&&n.setFontSize(17)})}setFeedback(t){"correct"===t?(this.feedbackTitleText.setText("Correct!"),this.feedbackTitleText.setColor("#22c55e"),this.feedbackSubtitleText.setText("You earned 1 point!"),this.feedbackSubtitleText.setColor("#16a34a"),this.feedbackTitleText.setAlpha(1),this.feedbackSubtitleText.setAlpha(1)):"wrong"===t?(this.feedbackTitleText.setText("Sorry!"),this.feedbackTitleText.setColor("#ef4444"),this.feedbackSubtitleText.setText("You have to start over."),this.feedbackSubtitleText.setColor("#0f172a"),this.feedbackTitleText.setAlpha(1),this.feedbackSubtitleText.setAlpha(1)):(this.feedbackTitleText.setAlpha(0),this.feedbackSubtitleText.setAlpha(0))}setOptionState(t,e){let i=this.optionButtons[t];i&&i.getData("redraw")(e)}layout(t,e){let i=r().Math.Clamp(t/900,.9,1.05),s=Math.floor(.9*t),a=Math.floor(.62*e/i),n=Math.floor(.8*s);this.questionText.setWordWrapWidth(n,!0),this.feedbackTitleText.setWordWrapWidth(n,!0),this.feedbackSubtitleText.setWordWrapWidth(n,!0);let o=28,l=0;for(;o>=20;){this.questionText.setFontSize(o);let t=this.questionText.getBounds();if((l=10+this.indexText.getBounds().height+8+22+4+18+8+t.height+14+62*this.optionCount+14*(this.optionCount-1)+14)<=a)break;o-=2}let h=this.questionText.getBounds(),d=this.indexText.getBounds().height,c=12,u=16,g=14,p=62,m=14,f=8,x=8;l>a&&(c=10,u=12,g=12,f=6,x=6);let S=Math.max(0,a-(c+d+f+22+4+18+x+h.height+g+u));if(p*this.optionCount+m*(this.optionCount-1)>S){let t=Math.floor((S-m*(this.optionCount-1))/this.optionCount),e=Math.floor((S-(p=r().Math.Clamp(t,52,p))*this.optionCount)/(this.optionCount-1));m=r().Math.Clamp(e,8,m)}l=c+d+f+22+4+18+x+h.height+g+p*this.optionCount+m*(this.optionCount-1)+u,this.panelContainer.setScale(i),this.panelContainer.setPosition(t/2,e/2),this.panelShadow.clear(),this.panelShadow.fillStyle(0,.18),this.panelShadow.fillRoundedRect(-s/2+8,-l/2+14,s,l,28),this.panelBg.clear(),this.panelBg.fillStyle(0xf8fbff,.92),this.panelBg.fillRoundedRect(-s/2,-l/2,s,l,28),this.panelBg.lineStyle(2,9684477,.6),this.panelBg.strokeRoundedRect(-s/2,-l/2,s,l,28),this.panelGlow.clear(),this.panelGlow.fillStyle(0xe0f2fe,.5),this.panelGlow.fillRoundedRect(-s/2+10,-l/2+10,s-20,l-20,20);let y=-l/2+c;this.indexText.setPosition(0,y);let T=y+d+f;this.feedbackTitleText.setPosition(0,T),this.feedbackSubtitleText.setPosition(0,T+22+4);let b=T+22+4+18+x;this.questionText.setPosition(0,b);let M=b+h.height+g+p/2;this.optionButtons.forEach((t,e)=>{let i=M+e*(p+m);t.setPosition(0,i),t.setData("layout",{x:-s/2+32,w:s-64,h:p,radius:22}),t.getData("redraw")("normal");let a=t.getData("text"),n=t.getData("hit"),r=t.getData("layout");a.setPosition(r.x+r.w/2,0),n.setSize(r.w,r.h),n.setPosition(r.x+r.w/2,0),t.setSize(r.w,r.h)});let P=l*i/2;return this.panelContainer.y-P<60&&(this.panelContainer.y=60+P),this.panelContainer.y+P>e-40&&(this.panelContainer.y=e-40-P),{uiScale:i,panelHeight:l,panelWidth:s}}createOptionButton(t,e){let i=this.scene.add.container(t,e),s=this.scene.add.graphics(),a=this.scene.add.graphics(),n=this.scene.add.text(0,0,"...",{fontFamily:"Arial Black",fontSize:"20px",color:"#ffffff"}).setOrigin(.5),r=this.scene.add.rectangle(0,0,640,54,0xffffff,.001);r.setInteractive();let o=t=>{var e,n,r,o;let l=i.getData("layout"),h=null!=(e=null==l?void 0:l.x)?e:-320,d=null!=(n=null==l?void 0:l.w)?n:640,c=null!=(r=null==l?void 0:l.h)?r:54,u=null!=(o=null==l?void 0:l.radius)?o:22,g=3718648,p=8246268;"correct"===t?(g=2278750,p=8843180):"wrong"===t&&(g=0xef4444,p=0xfca5a5),s.clear(),s.fillStyle(0,.18),s.fillRoundedRect(h+2,-c/2+4,d,c,u),a.clear(),a.fillStyle(g,1),a.fillRoundedRect(h,-c/2,d,c,u),a.lineStyle(2,p,.9),a.strokeRoundedRect(h,-c/2,d,c,u)};return o("normal"),i.add([s,a,n,r]),i.setSize(640,54),i.setData("redraw",o),i.setData("text",n),i.setData("hit",r),i}constructor(t,e={}){var i,s,a;this.optionButtons=[],this.scene=t,this.optionCount=null!=(i=e.optionCount)?i:4,this.showIndex=null==(s=e.showIndex)||s,this.container=this.scene.add.container(0,0).setDepth(null!=(a=e.depth)?a:200),this.container.setScrollFactor(0),this.container.setVisible(!1),this.panelContainer=this.scene.add.container(0,0),this.panelShadow=this.scene.add.graphics(),this.panelBg=this.scene.add.graphics(),this.panelGlow=this.scene.add.graphics(),this.indexText=this.scene.add.text(0,0,"Question 1/4",{fontFamily:"Arial Black",fontSize:"14px",color:"#38bdf8"}).setOrigin(.5,0),this.feedbackTitleText=this.scene.add.text(0,0,"Correct!",{fontFamily:"Arial Black",fontSize:"22px",color:"#22c55e",align:"center",wordWrap:{width:600,useAdvancedWrap:!0}}).setOrigin(.5,0),this.feedbackSubtitleText=this.scene.add.text(0,0,"You earned 1 point!",{fontFamily:"Arial Black",fontSize:"18px",color:"#16a34a",align:"center",wordWrap:{width:600,useAdvancedWrap:!0}}).setOrigin(.5,0),this.questionText=this.scene.add.text(0,0,"...",{fontFamily:"Arial Black",fontSize:"28px",color:"#0f172a",align:"center",wordWrap:{width:600,useAdvancedWrap:!0}}).setOrigin(.5,0),this.panelContainer.add([this.panelShadow,this.panelBg,this.panelGlow,this.indexText,this.feedbackTitleText,this.feedbackSubtitleText,this.questionText]);for(let t=0;t<this.optionCount;t+=1){let t=this.createOptionButton(0,0);this.optionButtons.push(t),this.panelContainer.add(t)}this.container.add(this.panelContainer),e.parent&&e.parent.add(this.container)}}class x extends n.Scene{init(t){var e,i,s,a,n;this.gameCode=h(null!=(e=null==t?void 0:t.gameCode)?e:this.registry.get("gameCode")),this.registry.set("gameCode",this.gameCode),this.gameConfig=d(this.gameCode),this.sessionId=null!=(i=null==t?void 0:t.sessionId)?i:null,this.sessionGameId=null!=(s=null==t?void 0:t.gameId)?s:null,this.sessionQuestions=null!=(a=null==t?void 0:t.questions)?a:null,this.sessionTimeLimit=null!=(n=null==t?void 0:t.timeLimit)?n:null}create(){let{width:t,height:e}=this.scale;this.camera=this.cameras.main,this.createParallaxBackground(),this.trackImage=this.add.image(t/2,e,this.gameConfig.mapKey).setOrigin(.5,1);let i=t/this.trackImage.width;this.trackImage.setScale(i);let s=this.trackImage.y-this.trackImage.displayHeight;this.camera.setBounds(0,s,t,this.trackImage.displayHeight),this.leafPath=this.gameConfig.useTexturePath?this.buildLeafPath(this.gameConfig.mapKey):[];let a=this.getLeafPosition(0);this.player=new m(this,a.x,a.y),this.currentLeafIndex=0;let n=this.getLeafPosition(this.currentLeafIndex+1);this.player.flip(n.x>a.x),this.player.playIdle(),this.camera.scrollY=a.y-900,this.uiCamera=this.cameras.add(0,0,t,e),this.uiCamera.setScroll(0,0),this.uiCamera.ignore(this.children.list),this.createUI(),this.sessionTimeLimit&&this.sessionTimeLimit>0&&(this.totalTimeMs=1e3*this.sessionTimeLimit),u.emit("current-scene-ready",this)}createParallaxBackground(){this.cameras.main.setBackgroundColor(this.gameConfig.backgroundColor),this.parallaxLayers=[]}update(){var t;if(!(null==(t=this.parallaxLayers)?void 0:t.length))return;let e=this.camera.scrollY;this.parallaxLayers.forEach(t=>{let i=t.getData("scrollFactor"),s=t.getData("baseY");t.y=s+e*i})}createUI(){let{width:t,height:e}=this.scale;this.uiRoot=this.add.container(0,0).setScrollFactor(0).setDepth(100),this.timerOverlay=this.add.container(0,0).setScrollFactor(0).setDepth(2e3),this.hudBackButton=this.add.container(0,0);let i=this.add.graphics();i.fillStyle(0xffffff,.95),i.fillRoundedRect(-24,-24,48,48,14),i.lineStyle(2,959977,.2),i.strokeRoundedRect(-24,-24,48,48,14);let s=this.add.text(0,1,"<",{fontFamily:"Arial Black",fontSize:"28px",color:"#0f172a"}).setOrigin(.5);this.hudBackButton.add([i,s]),this.hudBackButton.setSize(48,48),this.hudPointsPill=this.add.container(0,0);let a=this.add.graphics();a.fillStyle(0xe0f2fe,.98),a.fillRoundedRect(-85,-22,170,44,22),a.lineStyle(2,9684477,.7),a.strokeRoundedRect(-85,-22,170,44,22);let n=this.add.image(-61,0,"star").setScale(.32).setTint(0xfbbf24);this.scoreText=this.add.text(-39,0,"POINTS: 00",{fontFamily:"Arial Black",fontSize:"18px",color:"#0f172a"}).setOrigin(0,.5),this.hudPointsPill.add([a,n,this.scoreText]),this.hudTimerPill=this.add.container(0,0);let r=this.add.graphics();r.fillStyle(0xdbeafe,.98),r.fillRoundedRect(-50,-20,100,40,20),r.lineStyle(2,6333946,.6),r.strokeRoundedRect(-50,-20,100,40,20),this.timerText=this.add.text(0,0,"03:00",{fontFamily:"Arial Black",fontSize:"18px",color:"#0f172a"}).setOrigin(.5),this.hudTimerPill.add([r,this.timerText]),this.hudHeartsPill=this.add.container(0,0);let o=this.add.graphics();o.fillStyle(0xffffff,.98),o.fillRoundedRect(-46,-18,92,36,18),o.lineStyle(2,9684477,.35),o.strokeRoundedRect(-46,-18,92,36,18);let l=this.add.text(0,0,"❤ ❤ ❤",{fontFamily:"Arial Black",fontSize:"16px",color:"#ef4444"}).setOrigin(.5);this.hudHeartsPill.add([o,l]),this.timerOverlay.add([this.hudBackButton,this.hudPointsPill,this.hudTimerPill,this.hudHeartsPill]),this.uiRoot.add(this.timerOverlay),this.layoutHud(),this.jumpButton=this.createJumpButton(t/2,e-150),this.jumpButton.setScrollFactor(0),this.uiRoot.add(this.jumpButton),this.jumpButton.setVisible(!1),this.jumpButton.setActive(!1),this.setupJumpInput(),this.createQuizModal(),this.scale.on("resize",()=>{this.quizModal&&this.layoutQuiz(),this.layoutHud()}),this.createStartModal(),this.openStartModal(),this.cameras.main.ignore([this.uiRoot,this.timerOverlay]),this.createEndModal(),this.createTimeUpModal()}layoutHud(){if(!this.hudBackButton||!this.hudPointsPill||!this.hudTimerPill||!this.hudHeartsPill)return;let{width:t,height:e}=this.scale,i=Math.max(20,Math.round(.03*e)),s=Math.max(16,Math.round(.045*t));this.hudBackButton.setPosition(s+24,i+24),this.hudPointsPill.setPosition(t/2,i+24);let a=t-s;this.hudHeartsPill.setPosition(a-46,i+24),this.hudTimerPill.setPosition(a-92-10-50,i+24)}createJumpButton(t,e){let i=this.add.container(t,e),s=this.add.rectangle(0,0,300,100,0xfbbf24).setStrokeStyle(4,0xffffff).setFillStyle(2278750),a=this.add.text(0,0,"NEXT JUMP!",{fontFamily:"Arial Black",fontSize:"32px",color:"#ffffff"}).setOrigin(.5);i.add([s,a]),i.setSize(300,100),this.jumpButtonBg=s;let n=()=>{this.quizOpen||this.startModalOpen||(s.setFillStyle(1483594),this.openQuizModal())},r=()=>{s.setFillStyle(2278750)};return i.setInteractive(new Phaser.Geom.Rectangle(-150,-50,300,100),Phaser.Geom.Rectangle.Contains),i.on("pointerdown",n),i.on("pointerup",r),i.on("pointerout",r),this.tweens.add({targets:i,scale:1.05,duration:800,yoyo:!0,repeat:-1}),i}setupJumpInput(){this.input.enabled=!0,this.input.mouse&&(this.input.mouse.enabled=!0),this.input.on("pointerdown",t=>{this.quizOpen||this.startModalOpen||this.jumpButton.getBounds().contains(t.x,t.y)&&(this.jumpButtonBg.setFillStyle(1483594),this.openQuizModal())}),this.input.on("pointerup",()=>{this.jumpButtonBg.setFillStyle(2278750)})}createQuizModal(){this.quizPanel=new f(this,{optionCount:4,depth:200,parent:this.uiRoot,showIndex:!0}),this.quizModal=this.quizPanel.container,this.quizPanelContainer=this.quizPanel.panelContainer,this.quizPanelShadow=this.quizPanel.panelShadow,this.quizPanelBg=this.quizPanel.panelBg,this.quizPanelGlow=this.quizPanel.panelGlow,this.quizIndexText=this.quizPanel.indexText,this.quizFeedbackTitleText=this.quizPanel.feedbackTitleText,this.quizFeedbackSubtitleText=this.quizPanel.feedbackSubtitleText,this.quizQuestionText=this.quizPanel.questionText,this.quizOptionButtons=this.quizPanel.optionButtons,this.quizPanel.onOptionSelected(t=>{this.quizOpen&&!this.quizLocked&&this.handleQuizAnswer(t)}),this.layoutQuiz()}createStartModal(){let{width:t,height:e}=this.scale,i=this.add.container(0,0).setScrollFactor(0).setDepth(220),s=this.add.rectangle(0,0,t,e,0,.12).setOrigin(0,0),a=Math.min(520,t-80),n=this.add.container(t/2,Math.round(.58*e)).setScrollFactor(0),r=this.add.graphics();r.fillStyle(0,.15),r.fillRoundedRect(-a/2+6,-70,a,160,26);let o=this.add.graphics();o.fillStyle(0xffffff,.85),o.fillRoundedRect(-a/2,-80,a,160,24),o.lineStyle(2,9684477,.45),o.strokeRoundedRect(-a/2,-80,a,160,24);let l=this.add.text(0,-26,"Help the robot cross the river.",{fontFamily:"Arial Black",fontSize:"22px",color:"#0f172a",align:"center",wordWrap:{width:a-60,useAdvancedWrap:!0}}).setOrigin(.5),h=this.createStartButton(0,42);n.add([r,o,l,h]),i.add([s,n]),i.setVisible(!1),this.startModal=i,this.uiRoot&&this.uiRoot.add(i)}createEndModal(){let{width:t,height:e}=this.scale,i=this.add.container(0,0).setScrollFactor(0).setDepth(230),s=this.add.rectangle(0,0,t,e,0,.6).setOrigin(0,0),a=Math.min(520,t-80),n=this.add.container(t/2,Math.round(.56*e)).setScrollFactor(0);s.setDepth(0),n.setDepth(1);let r=this.add.zone(0,0,t,e).setOrigin(0,0);r.setInteractive(new Phaser.Geom.Rectangle(0,0,t,e),(t,e,i)=>{let s=n.getBounds();return!Phaser.Geom.Rectangle.Contains(s,e,i)&&Phaser.Geom.Rectangle.Contains(t,e,i)}),r.on("pointerdown",()=>{});let o=this.add.graphics();o.fillStyle(0,.15),o.fillRoundedRect(-a/2+6,-100,a,220,26);let l=this.add.graphics();l.fillStyle(0xffffff,.85),l.fillRoundedRect(-a/2,-110,a,220,24),l.lineStyle(2,9684477,.45),l.strokeRoundedRect(-a/2,-110,a,220,24);let h=this.add.text(0,-64,"Congratulations!",{fontFamily:"Arial Black",fontSize:"22px",color:"#0f172a"}).setOrigin(.5),d=this.add.text(0,-36,"You completed the run.",{fontFamily:"Arial",fontSize:"18px",color:"#0f172a",align:"center",wordWrap:{width:a-60,useAdvancedWrap:!0}}).setOrigin(.5),c=Math.min(200,Math.floor((a-120)/2)),u=this.add.graphics();u.fillStyle(9684477,.18),u.fillRoundedRect(-c/2,-23,c,46,16),u.lineStyle(2,9684477,.45),u.strokeRoundedRect(-c/2,-23,c,46,16);let g=this.add.graphics();g.fillStyle(9684477,.18),g.fillRoundedRect(-c/2,-23,c,46,16),g.lineStyle(2,9684477,.45),g.strokeRoundedRect(-c/2,-23,c,46,16);let p=this.add.container(-c/2-8,62,[u]),m=this.add.container(c/2+8,62,[g]),f=this.add.text(p.x,46,"SCORE",{fontFamily:"Arial Black",fontSize:"12px",color:"#1e3a8a"}).setOrigin(.5),x=this.add.text(m.x,46,"TIME",{fontFamily:"Arial Black",fontSize:"12px",color:"#1e3a8a"}).setOrigin(.5);this.endModalScoreText=this.add.text(p.x,68,"0",{fontFamily:"Arial Black",fontSize:"18px",color:"#0f172a"}).setOrigin(.5),this.endModalTimeText=this.add.text(m.x,68,"00:00",{fontFamily:"Arial Black",fontSize:"18px",color:"#0f172a"}).setOrigin(.5);let S=this.createEndRestartButton(0,166);S.setDepth(2),n.add([o,l,h,d,p,m,f,x,this.endModalScoreText,this.endModalTimeText]),n.add(S),i.add([s,r,n]),i.setVisible(!1),this.endModal=i,this.endModal.setData("panel",n),this.endModal.setData("overlay",s),this.uiRoot&&this.uiRoot.add(i)}createEndRestartButton(t,e){let i=this.add.container(t,e).setScrollFactor(0),s=this.add.graphics();s.fillStyle(0,.2),s.fillRoundedRect(-126,-20,260,52,20);let a=this.add.graphics(),n=(t,e)=>{a.clear(),a.fillStyle(t,1),a.fillRoundedRect(-130,-26,260,52,20),a.lineStyle(2,e,.8),a.strokeRoundedRect(-130,-26,260,52,20)};n(3900150,9684477);let r=this.add.text(0,0,"Play Again",{fontFamily:"Arial Black",fontSize:"20px",color:"#ffffff"}).setOrigin(.5),o=this.add.rectangle(0,0,260,52,0xffffff,.001);return o.setInteractive(),i.add([s,a,r,o]),i.setSize(260,52),o.on("pointerover",()=>{n(2450411,0xbfdbfe),this.tweens.add({targets:i,scale:1.02,duration:120,ease:"Sine.easeOut"})}),o.on("pointerout",()=>{n(3900150,9684477),this.tweens.add({targets:i,scale:1,duration:120,ease:"Sine.easeOut"})}),o.on("pointerdown",()=>{n(1920728,0xbfdbfe),this.tweens.add({targets:i,scale:.98,duration:80,ease:"Sine.easeOut"}),this.restartRun()}),o.on("pointerup",()=>{n(2450411,0xbfdbfe),this.tweens.add({targets:i,scale:1.02,duration:80,ease:"Sine.easeOut"})}),i}createTimeUpModal(){let{width:t,height:e}=this.scale,i=this.add.container(0,0).setScrollFactor(0).setDepth(240),s=this.add.rectangle(0,0,t,e,0,.12).setOrigin(0,0),a=Math.min(520,t-80),n=this.add.container(t/2,Math.round(.56*e)).setScrollFactor(0),r=this.add.graphics();r.fillStyle(0,.15),r.fillRoundedRect(-a/2+6,-70,a,160,26);let o=this.add.graphics();o.fillStyle(0xffffff,.85),o.fillRoundedRect(-a/2,-80,a,160,24),o.lineStyle(2,9684477,.45),o.strokeRoundedRect(-a/2,-80,a,160,24);let l=this.add.text(0,-26,"Out of time! Failed",{fontFamily:"Arial Black",fontSize:"22px",color:"#0f172a"}).setOrigin(.5),h=this.createRestartButton(0,42);n.add([r,o,l,h]),i.add([s,n]),i.setVisible(!1),this.timeUpModal=i,this.timeUpModal.setData("panel",n),this.uiRoot&&this.uiRoot.add(i)}createRestartButton(t,e){let i=this.add.container(t,e).setScrollFactor(0),s=this.add.graphics();s.fillStyle(0,.2),s.fillRoundedRect(-126,-20,260,52,20);let a=this.add.graphics(),n=(t,e)=>{a.clear(),a.fillStyle(t,1),a.fillRoundedRect(-130,-26,260,52,20),a.lineStyle(2,e,.8),a.strokeRoundedRect(-130,-26,260,52,20)};n(3900150,9684477);let r=this.add.text(0,0,"Continue",{fontFamily:"Arial Black",fontSize:"20px",color:"#ffffff"}).setOrigin(.5),o=this.add.rectangle(0,0,260,52,0xffffff,.001);return o.setInteractive(),i.add([s,a,r,o]),i.setSize(260,52),o.on("pointerover",()=>{n(2450411,0xbfdbfe),this.tweens.add({targets:i,scale:1.02,duration:120,ease:"Sine.easeOut"})}),o.on("pointerout",()=>{n(3900150,9684477),this.tweens.add({targets:i,scale:1,duration:120,ease:"Sine.easeOut"})}),o.on("pointerdown",()=>{n(1920728,0xbfdbfe),this.tweens.add({targets:i,scale:.98,duration:80,ease:"Sine.easeOut"}),this.restartRun()}),o.on("pointerup",()=>{n(2450411,0xbfdbfe),this.tweens.add({targets:i,scale:1.02,duration:80,ease:"Sine.easeOut"})}),i}createStartButton(t,e){let i=this.add.container(t,e).setScrollFactor(0),s=this.add.graphics();s.fillStyle(0,.2),s.fillRoundedRect(-126,-20,260,52,20);let a=this.add.graphics(),n=(t,e)=>{a.clear(),a.fillStyle(t,1),a.fillRoundedRect(-130,-26,260,52,20),a.lineStyle(2,e,.8),a.strokeRoundedRect(-130,-26,260,52,20)};n(3900150,9684477);let r=this.add.text(0,0,"Start Game",{fontFamily:"Arial Black",fontSize:"20px",color:"#ffffff"}).setOrigin(.5),o=this.add.rectangle(0,0,292,84,0xffffff,.001);o.setInteractive(),i.add([s,a,r,o]),i.setSize(260,52);let l=()=>{this.startModalOpen&&(n(1920728,0xbfdbfe),this.closeStartModal(),this.openQuizModal())},h=()=>{n(3900150,9684477)};return o.on("pointerdown",l),o.on("pointerup",h),o.on("pointerout",h),this.tweens.add({targets:i,scale:1.05,duration:800,yoyo:!0,repeat:-1}),i}openStartModal(){this.startModalOpen=!0,this.jumpButton.setAlpha(.4),this.stopTimer(),this.startModal.setVisible(!0),this.startModal.setAlpha(0),this.tweens.add({targets:this.startModal,alpha:1,duration:180})}closeStartModal(){this.startModalOpen=!1,this.jumpButton.setAlpha(1),this.startTimer(),this.startModal.setVisible(!1)}setQuestion(t){this.quizPanel.setFeedback("idle"),this.quizPanel.setQuestion(t),this.layoutQuiz()}layoutQuiz(){if(!this.quizPanel)return;let{width:t,height:e}=this.scale,i=this.quizPanel.layout(t,e);this.uiScale=i.uiScale,this.quizPanelHeight=i.panelHeight,this.quizPanelWidth=i.panelWidth}openQuizModal(){if(this.gameOver||this.gameCompleted||this.player.isJumping())return;this.quizOpen=!0,this.quizLocked=!1,this.jumpButton.setAlpha(.6);let t=this.getQuestionPool(),e=t[this.quizCurrentIndex%t.length];this.setQuestion({index:this.quizCurrentIndex+1,total:t.length,question:e.question,options:e.options}),this.quizModal.setVisible(!0),this.quizModal.setAlpha(0);let i=this.quizPanel.panelContainer;i.setScale(.96),i.y+=18,this.tweens.add({targets:this.quizModal,alpha:1,duration:180}),this.tweens.add({targets:i,scale:1,y:i.y-18,duration:220,ease:"Back.easeOut"})}closeQuizModal(){this.quizOpen=!1,this.quizLocked=!1,this.jumpButton.setAlpha(1),this.quizModal.setVisible(!1)}async handleQuizAnswer(t){let e=this.getQuestionPool(),s=e[this.quizCurrentIndex%e.length],a=t===s.correctIndex,n=s.optionIds[t];if(this.sessionId&&s.sessionQuestionId&&n)try{let{submitAnswer:t}=await Promise.resolve().then(i.bind(i,143));a=(await t(this.sessionId,s.sessionQuestionId,n,{forceReal:"vocab_race"===this.gameCode})).data.is_correct}catch(t){console.error("submitAnswer failed, fallback to local check",t)}let r=this.quizOptionButtons[t].getData("redraw");if(a)this.quizLocked=!0,r("correct"),this.setQuizFeedback("correct"),this.updateScore(1),this.speedUpJump(),await this.delay(400),this.closeQuizModal(),await this.handleJump(),this.quizCurrentIndex+=1,this.time.delayedCall(250,()=>{this.openQuizModal()});else{this.quizLocked=!0,r("wrong"),this.setQuizFeedback("wrong"),this.updateScore(-1),this.showPlayerState("incorrect");let t=this.quizPanel.panelContainer,e=t.x;this.tweens.add({targets:t,x:e+10,duration:60,yoyo:!0,repeat:3,ease:"Sine.easeInOut",onComplete:()=>{t.x=e,this.quizLocked=!1,r("normal")}})}}getQuestionPool(){let t=this.sessionQuestions;if(null==t?void 0:t.length){if(!this.questionSourceLogged){var e,i,s;this.questionSourceLogged=!0,console.log("[GAME][TOWN] Using session questions",{gameCode:this.gameCode,count:t.length,sample:null!=(s=null==(i=t[0])||null==(e=i.question)?void 0:e.content)?s:null})}return t.map(t=>{var e;let i=t.question.options.map(t=>t.text),s=t.question.options.map(t=>{var e;return null!=(e=t.id)?e:""}),a=t.question.options.findIndex(t=>t.is_correct);return a<0&&(a=0),{sessionQuestionId:null!=(e=t.session_question_id)?e:null,question:t.question.content,options:i,optionIds:s,correctIndex:a}})}return this.questionSourceLogged||(this.questionSourceLogged=!0,console.warn("[GAME][TOWN] Using fallback local questions",{gameCode:this.gameCode})),[{sessionQuestionId:null,question:"What is the capital of Vietnam?",options:["Hanoi","Da Nang","Hai Phong","Can Tho"],optionIds:["","","",""],correctIndex:0},{sessionQuestionId:null,question:"Which language does Phaser use?",options:["TypeScript/JavaScript","C#","Python","Go"],optionIds:["","","",""],correctIndex:0},{sessionQuestionId:null,question:"What color are the leaves in the game?",options:["Green","Red","Purple","Yellow"],optionIds:["","","",""],correctIndex:0}]}async handleJump(){if(this.player.isJumping()||this.gameOver)return;let t=this.currentLeafIndex+1,e=this.leafPath.length>0?this.leafPath.length-1:1/0;if(this.leafPath.length>0&&t>e)return;let i=this.getLeafPosition(t);this.player.stopIdle(),this.tweens.add({targets:this.camera,scrollY:i.y-800,duration:600,ease:"Sine.easeInOut"}),await this.player.jumpTo(i.x,i.y,this.jumpDurationMs),this.currentLeafIndex=t;let s=this.getLeafPosition(this.currentLeafIndex+1);this.player.flip(s.x>i.x),this.player.showCorrect(800),this.time.delayedCall(800,()=>{this.player.playIdle()}),this.leafPath.length>0&&this.currentLeafIndex>=e&&(this.gameCompleted=!0,this.jumpButton.setAlpha(.4),this.quizOpen=!1,this.quizLocked=!1,this.stopTimer(),this.timerOverlay.setVisible(!1),this.totalTimeMs>0&&this.updateScore(3),this.updateEndTimeText(),this.time.delayedCall(400,()=>{this.openEndModal()}))}startTimer(){this.timerEvent&&this.timerEvent.remove(!1),this.totalTimeMs=this.sessionTimeLimit&&this.sessionTimeLimit>0?1e3*this.sessionTimeLimit:18e4,this.updateTimerText(this.totalTimeMs),this.timerEvent=this.time.addEvent({delay:1e3,loop:!0,callback:()=>{this.gameCompleted||this.gameOver||(this.totalTimeMs-=1e3,this.updateTimerText(this.totalTimeMs),this.totalTimeMs<=0&&(this.totalTimeMs=0,this.updateTimerText(this.totalTimeMs),this.handleTimeUp()))}})}stopTimer(){this.timerEvent&&this.timerEvent.remove(!1)}updateTimerText(t){let e,i=Math.max(0,Math.floor(t/1e3)),s=Math.floor(i/60),a="".concat(s,"m ").concat((e=i%60)<10?"0".concat(e):"".concat(e),"s");this.timerText.setText(a)}handleTimeUp(){this.gameOver||this.gameCompleted||(this.gameOver=!0,this.quizOpen=!1,this.quizLocked=!1,this.jumpButton.setAlpha(.4),this.closeQuizModal(),this.openTimeUpModal())}openEndModal(){if(!this.endModal)return;let t=this.endModal.getData("panel"),e=this.endModal.getData("overlay");t.setScale(.9),e&&e.setAlpha(0),this.endModal.setVisible(!0),this.endModal.setAlpha(1),this.launchConfetti(),this.submitSessionResult(),this.tweens.add({targets:e,alpha:.6,duration:200}),this.tweens.add({targets:t,scale:1,duration:260,ease:"Back.easeOut"})}launchConfetti(){this.confettiEmitter&&this.confettiEmitter.destroy(),this.confettiBurstEvent&&(this.confettiBurstEvent.remove(!1),this.confettiBurstEvent=void 0);let{width:t,height:e}=this.scale;this.confettiEmitter=this.add.particles(0,0,"tile-flower",{speed:{min:90,max:170},angle:{min:0,max:360},rotate:{min:-220,max:220},scale:{start:.32,end:.1},lifespan:{min:1400,max:2200},quantity:0,frequency:-1,gravityY:160}),this.confettiEmitter.setScrollFactor(0),this.confettiEmitter.setDepth(2100),this.uiRoot.add(this.confettiEmitter),this.confettiBurstEvent=this.time.addEvent({delay:900,repeat:0,callback:()=>{this.confettiEmitter&&this.confettiEmitter.explode(18,t/2,e/2)}}),this.time.delayedCall(3500,()=>{var t,e;null==(t=this.confettiEmitter)||t.destroy(),this.confettiEmitter=void 0,null==(e=this.confettiBurstEvent)||e.remove(!1),this.confettiBurstEvent=void 0})}openTimeUpModal(){if(!this.timeUpModal)return;let t=this.timeUpModal.getData("panel");t.setScale(.96),this.timeUpModal.setVisible(!0),this.timeUpModal.setAlpha(0),this.tweens.add({targets:this.timeUpModal,alpha:1,duration:200}),this.tweens.add({targets:t,scale:1,duration:240,ease:"Back.easeOut"})}closeTimeUpModal(){this.timeUpModal&&this.timeUpModal.setVisible(!1)}closeEndModal(){if(!this.endModal)return;this.endModal.setVisible(!1),this.endModal.setAlpha(0);let t=this.endModal.getData("overlay");t&&t.setAlpha(0),this.confettiEmitter&&(this.confettiEmitter.destroy(),this.confettiEmitter=void 0),this.confettiBurstEvent&&(this.confettiBurstEvent.remove(!1),this.confettiBurstEvent=void 0)}submitSessionResult(){this.sessionGameId&&Promise.resolve().then(i.bind(i,143)).then(t=>{let{endGameSession:e}=t;return e(this.sessionGameId,this.score,{forceReal:"vocab_race"===this.gameCode})}).catch(t=>{console.error("endGameSession failed",t)})}restartRun(){this.gameOver=!1,this.gameCompleted=!1,this.quizOpen=!1,this.quizLocked=!1,this.quizCurrentIndex=0,this.startModalOpen=!1,this.score=0,this.scoreText.setText("POINTS: 00"),this.jumpDurationMs=900,this.closeTimeUpModal(),this.closeQuizModal(),this.closeEndModal(),this.startModal&&this.startModal.setVisible(!1);let t=this.getLeafPosition(0);this.player.setPosition(t.x,t.y),this.player.playIdle(),this.currentLeafIndex=0;let e=this.getLeafPosition(this.currentLeafIndex+1);this.player.flip(e.x>t.x),this.camera.scrollY=t.y-900,this.stopTimer(),this.timerOverlay.setVisible(!0),this.jumpButton.setAlpha(1),this.startTimer(),this.openQuizModal()}updateScore(t){this.score+=t;let e=Math.max(0,this.score);this.scoreText.setText("POINTS: ".concat(e.toString().padStart(2,"0"))),this.endModalScoreText&&this.endModalScoreText.setText("Score: ".concat(this.score))}updateEndTimeText(){if(!this.endModalTimeText)return;let t=Math.max(0,Math.floor(((this.sessionTimeLimit&&this.sessionTimeLimit>0?1e3*this.sessionTimeLimit:18e4)-this.totalTimeMs)/1e3)),e=Math.floor(t/60),i=t=>t<10?"0".concat(t):"".concat(t);this.endModalTimeText.setText("Time: ".concat(i(e),":").concat(i(t%60)))}speedUpJump(){this.jumpDurationMs=Math.max(450,this.jumpDurationMs-40)}getLeafPosition(t){if(this.leafPath.length>0&&this.trackImage){let e=Math.min(t,this.leafPath.length-1),i=this.leafPath[e],s=this.trackImage.scaleX,a=this.trackImage.x-this.trackImage.displayWidth/2,n=this.trackImage.y-this.trackImage.displayHeight;return{x:a+i.x*s,y:n+i.y*s}}let e=this.scale.width/2,i=this.leafStartY-t*this.leafStepY;return{x:t%2==0?e-this.leafSideOffset:e+this.leafSideOffset,y:i}}buildLeafPath(t){let e=this.textures.get(t),i=null==e?void 0:e.getSourceImage();if(!i||!i.width||!i.height)return[];let s=this.sys.game.canvas.ownerDocument.createElement("canvas");s.width=i.width,s.height=i.height;let a=s.getContext("2d");if(!a)return[];a.drawImage(i,0,0);let n=a.getImageData(0,0,i.width,i.height).data,r=i.width,o=i.height,l=new Uint8Array(r*o),h=[],d=t=>{let e=n[t]/255,i=n[t+1]/255,s=n[t+2]/255,a=Math.max(e,i,s),r=a-Math.min(e,i,s);if(0===r)return!1;let o=0;return(o=Math.round(60*(o=a===e?(i-s)/r%6:a===i?(s-e)/r+2:(e-i)/r+4)))<0&&(o+=360),o>=70&&o<=150&&(0===a?0:r/a)>=.35},c=[];for(let t=0;t<o;t++)for(let e=0;e<r;e++){let i=t*r+e;if(l[i])continue;if(!d(4*i)){l[i]=1;continue}let s=0,a=0,n=0,u=e,g=e,p=t,m=t;for(c.push(i),l[i]=1;c.length;){let t=c.pop(),e=Math.floor(t/r),i=t-e*r;if(d(4*t)){if(s+=i,a+=e,n+=1,i<u&&(u=i),i>g&&(g=i),e<p&&(p=e),e>m&&(m=e),i>0){let e=t-1;l[e]||(d(4*e)?(l[e]=1,c.push(e)):l[e]=1)}if(i<r-1){let e=t+1;l[e]||(d(4*e)?(l[e]=1,c.push(e)):l[e]=1)}if(e>0){let e=t-r;l[e]||(d(4*e)?(l[e]=1,c.push(e)):l[e]=1)}if(e<o-1){let e=t+r;l[e]||(d(4*e)?(l[e]=1,c.push(e)):l[e]=1)}}}if(n>=4500){let t=g-u,e=m-p,i=t/(e||1);t>=90&&e>=90&&i>.6&&i<1.7&&h.push(new Phaser.Math.Vector2(s/n,a/n))}}return h.sort((t,e)=>{let i=e.y-t.y;return Math.abs(i)>2?i:t.x-e.x}),h}showPlayerState(t){"correct"===t?this.player.showCorrect(800):this.player.showIncorrect(800)}setQuizFeedback(t){this.quizPanel&&(this.quizPanel.setFeedback(t),this.quizFeedbackState=t)}delay(t){return new Promise(e=>{this.time.delayedCall(t,()=>e())})}constructor(){super("Game"),this.quizPanelWidth=0,this.quizPanelHeight=0,this.uiScale=1,this.safeInsetBottom=16,this.quizFeedbackState="idle",this.quizOptionButtons=[],this.quizOpen=!1,this.quizLocked=!1,this.quizCurrentIndex=0,this.startModalOpen=!1,this.gameCompleted=!1,this.gameOver=!1,this.totalTimeMs=18e4,this.jumpDurationMs=900,this.score=0,this.currentLeafIndex=0,this.sessionId=null,this.sessionGameId=null,this.sessionQuestions=null,this.sessionTimeLimit=null,this.questionSourceLogged=!1,this.gameCode="vocab_race",this.gameConfig=d("vocab_race"),this.leafPath=[],this.leafStartY=940,this.leafStepY=140,this.leafSideOffset=180}}let S=[{question:{content:"Thủ đ\xf4 của Việt Nam l\xe0 g\xec?",options:[{text:"H\xe0 Nội",is_correct:!0},{text:"Đ\xe0 Nẵng",is_correct:!1},{text:"Hải Ph\xf2ng",is_correct:!1},{text:"Cần Thơ",is_correct:!1}]}},{question:{content:"Phaser sử dụng ng\xf4n ngữ n\xe0o?",options:[{text:"TypeScript/JavaScript",is_correct:!0},{text:"C#",is_correct:!1},{text:"Python",is_correct:!1},{text:"Go",is_correct:!1}]}},{question:{content:"Chọn từ tr\xe1i nghĩa của “fast”.",options:[{text:"slow",is_correct:!0},{text:"far",is_correct:!1},{text:"high",is_correct:!1},{text:"small",is_correct:!1}]}},{question:{content:"Chọn đ\xe1p \xe1n đ\xfang: She ___ to school every day.",options:[{text:"goes",is_correct:!0},{text:"go",is_correct:!1},{text:"going",is_correct:!1},{text:"gone",is_correct:!1}]}},{question:{content:"Từ n\xe0o c\xf3 nghĩa l\xe0 “nhảy”?",options:[{text:"jump",is_correct:!0},{text:"swim",is_correct:!1},{text:"crawl",is_correct:!1},{text:"sleep",is_correct:!1}]}},{question:{content:"Từ n\xe0o l\xe0 danh từ?",options:[{text:"river",is_correct:!0},{text:"run",is_correct:!1},{text:"quickly",is_correct:!1},{text:"blue",is_correct:!1}]}},{question:{content:"Chọn c\xe2u đ\xfang ngữ ph\xe1p.",options:[{text:"He is playing football.",is_correct:!0},{text:"He are playing football.",is_correct:!1},{text:"He playing football.",is_correct:!1},{text:"He play football.",is_correct:!1}]}},{question:{content:"Từ n\xe0o l\xe0 t\xednh từ?",options:[{text:"beautiful",is_correct:!0},{text:"beauty",is_correct:!1},{text:"beautify",is_correct:!1},{text:"beautifully",is_correct:!1}]}},{question:{content:"Chọn đ\xe1p \xe1n đ\xfang: I ___ a book now.",options:[{text:"am reading",is_correct:!0},{text:"read",is_correct:!1},{text:"reads",is_correct:!1},{text:"reading",is_correct:!1}]}},{question:{content:"Từ n\xe0o l\xe0 trạng từ?",options:[{text:"quickly",is_correct:!0},{text:"quick",is_correct:!1},{text:"quicker",is_correct:!1},{text:"quickness",is_correct:!1}]}},{question:{content:"Chọn c\xe2u hỏi ph\xf9 hợp khi gặp người mới.",options:[{text:"What is your name?",is_correct:!0},{text:"Where do you live?",is_correct:!1},{text:"How old are you?",is_correct:!1},{text:"What time is it?",is_correct:!1}]}}];class y extends n.Scene{init(t){var e,i,s,a,n;this.gameCode=h(null!=(e=null==t?void 0:t.gameCode)?e:this.registry.get("gameCode")),this.registry.set("gameCode",this.gameCode),this.sessionId=null!=(i=null==t?void 0:t.sessionId)?i:null,this.sessionGameId=null!=(s=null==t?void 0:t.gameId)?s:null,this.sessionQuestions=null!=(a=null==t?void 0:t.questions)?a:null,this.sessionTimeLimit=null!=(n=null==t?void 0:t.timeLimit)?n:null}create(){let{width:t,height:e}=this.scale,i=d(this.gameCode);this.gameOver=!1,this.quizOpen=!1,this.quizLocked=!1,this.startModalOpen=!1,this.hasStarted=!1,this.currentSessionQuestionId=null,this.currentOptionIds=[],this.leadCarState="idle",this.barrierIsOpen=!1,this.carSlots=[],this.leadCarBadge=void 0,this.camera=this.cameras.main,this.camera.setBackgroundColor(i.backgroundColor),this.background=this.add.image(t/2,e/2,"train-bg").setDisplaySize(t,e).setOrigin(.5,.5),this.setupQuestions(),this.setupTimer(),this.createHud(),this.currentIndex=0,this.score=0,this.createRailway(),this.showCars&&(this.layoutTrain(),this.updateTrainCars(!0)),this.createBarrierGate(),this.createQuizModal(),this.createStartModal(),this.createTimeUpModal(),this.openStartModal(),this.scale.on("resize",()=>{let{width:t,height:e}=this.scale;this.background.setPosition(t/2,e/2).setDisplaySize(t,e),this.layoutHud(),this.layoutQuiz(),this.updateBarrierPosition(),this.layoutStartModal(),this.layoutTimeUpModal()}),u.emit("current-scene-ready",this)}update(t,e){if(this.gameOver)return;if(!this.hasStarted)return void this.updateTrainCars();this.remainingMs=Math.max(0,this.remainingMs-e);let i=Math.ceil(this.remainingMs/1e3);i!==this.lastSecondShown&&(this.lastSecondShown=i,this.timerText.setText(this.formatTime(i))),this.remainingMs<=0&&!this.gameOver&&this.endGame("Out of time.","lose"),this.updateTrainCars()}setupQuestions(){let t=this.sessionQuestions&&this.sessionQuestions.length>0?this.sessionQuestions:S;this.questions=t.slice(0)}setupTimer(){this.sessionTimeLimit&&this.sessionTimeLimit>0&&(this.totalTimeMs=1e3*this.sessionTimeLimit),this.remainingMs=this.totalTimeMs}createHud(){this.uiRoot=this.add.container(0,0).setDepth(2e3),this.hudBackButton=this.add.container(0,0);let t=this.add.graphics();t.fillStyle(0xffffff,.95),t.fillRoundedRect(-22,-22,44,44,14),t.lineStyle(2,959977,.2),t.strokeRoundedRect(-22,-22,44,44,14);let e=this.add.text(0,1,"<",{fontFamily:"Arial Black",fontSize:"26px",color:"#0f172a"}).setOrigin(.5);this.hudBackButton.add([t,e]),this.hudBackButton.setSize(44,44),this.hudBackButton.setInteractive(new Phaser.Geom.Rectangle(-22,-22,44,44),Phaser.Geom.Rectangle.Contains),this.hudBackButton.on("pointerdown",()=>{this.quizOpen||this.scene.start("MainMenu")}),this.hudPointsPill=this.add.container(0,0);let i=this.add.graphics();i.fillStyle(0xffffff,.98),i.fillRoundedRect(-84,-22,168,44,22),i.lineStyle(2,0xf59e0b,.4),i.strokeRoundedRect(-84,-22,168,44,22);let s=this.add.image(-60,0,"star").setScale(.32).setTint(0xfbbf24);this.scoreText=this.add.text(-38,0,"POINTS: 00",{fontFamily:"Arial Black",fontSize:"18px",color:"#0f172a"}).setOrigin(0,.5),this.hudPointsPill.add([i,s,this.scoreText]),this.hudTimerPill=this.add.container(0,0);let a=this.add.graphics();a.fillStyle(0xffffff,.98),a.fillRoundedRect(-48,-20,96,40,20),a.lineStyle(2,9741240,.4),a.strokeRoundedRect(-48,-20,96,40,20),this.timerText=this.add.text(0,0,this.formatTime(Math.ceil(this.remainingMs/1e3)),{fontFamily:"Arial Black",fontSize:"16px",color:"#0f172a"}).setOrigin(.5),this.hudTimerPill.add([a,this.timerText]),this.uiRoot.add([this.hudBackButton,this.hudPointsPill,this.hudTimerPill]),this.layoutHud(),this.createTrafficLight()}layoutHud(){let{width:t,height:e}=this.scale,i=Math.max(16,Math.round(.03*e)),s=Math.max(14,Math.round(.04*t));this.hudBackButton.setPosition(s+22,i+22),this.hudPointsPill.setPosition(t/2,i+22),this.hudTimerPill.setPosition(t-s-48,i+22)}createTrafficLight(){let t=Math.round(52.66575529733424),e=Math.round(923),i=this.add.container(88,e).setDepth(1e3),s=0,a=0,n=0,r=0,o=-1,l=0,h=this.textures.exists("train-light-red")?this.add.image(0,0,"train-light-red"):this.add.rectangle(0,0,t,230,0xef4444,1),d=this.textures.exists("train-light-yellow")?this.add.image(0,0,"train-light-yellow"):this.add.rectangle(0,0,t,230,0xfbbf24,1),c=this.textures.exists("train-light-green")?this.add.image(0,0,"train-light-green"):this.add.rectangle(0,0,t,230,2278750,1),u=e=>{"setOrigin"in e&&e.setOrigin(.5,1),"setDisplaySize"in e&&e.setDisplaySize(t,230)};u(h),u(d),u(c),h.setPosition(s,a),d.setPosition(n,r),c.setPosition(o,l),i.add([h,d,c]),this.trafficLightVariants={red:h,yellow:d,green:c},this.trafficLight=this.trafficLightVariants.red;let g=["red","yellow","green"],p=0;this.setTrafficLightColor(g[p]),this.time.addEvent({delay:700,loop:!0,callback:()=>{p=(p+1)%g.length,this.setTrafficLightColor(g[p])}})}setTrafficLightColor(t){if(!this.trafficLightVariants||this.trafficLightState===t)return;this.trafficLightState=t;let{red:e,yellow:i,green:s}=this.trafficLightVariants;e.setVisible("red"===t),i.setVisible("yellow"===t),s.setVisible("green"===t)}layoutTrain(){var t,e;let{width:i,height:s}=this.scale,a=Math.min(this.background.displayWidth/this.background.width,this.background.displayHeight/this.background.height)*this.trainCarScaleFactor,n=this.createTrackCurve(i,s),r=this.sampleTrack(n,this.maxCars);this.carSlots=[];for(let t=0;t<this.maxCars;t+=1){let n="train-car-".concat(t+1),o=null!=(e=r[t])?e:{x:i/2,y:s/2},l=this.getTrackAngle(r,t)+this.trainRotationOffset,h=this.add.image(o.x,o.y,n).setScale(a).setRotation(l);h.setAlpha(1);let d=this.createLockOverlay(o.x,o.y,h.displayWidth,h.displayHeight,t);d.setVisible(!1),d.disableInteractive(),this.carSlots.push({index:t,car:h,lock:d})}if(this.carSlots.length>0){let t=this.carSlots[0].car,e=Math.max(t.displayWidth,t.displayHeight);this.trainGapPx=e*this.trainCarGapFactor,this.trainStepPx=this.trainGapPx,this.leadCarBaseSize={width:t.displayWidth,height:t.displayHeight}}null==(t=this.carSlots[0])||t.car.setTexture("train-car-1"),this.setLeadCarState("idle"),this.refreshLocks()}getLeadCarTextureKey(t){switch(t){case"correct":return"train-fox-correct";case"incorrect":return"train-fox-incorrect";default:return"train-fox-idle"}}setLeadCarState(t){var e;this.leadCarState=t;let i=null==(e=this.carSlots[0])?void 0:e.car;if(!i||!i.scene)return;this.leadCarBadge&&!this.leadCarBadge.scene&&(this.leadCarBadge=void 0),"train-car-1"!==i.texture.key&&i.setTexture("train-car-1"),this.leadCarBaseSize&&(i.setDisplaySize(this.leadCarBaseSize.width,this.leadCarBaseSize.height),i.setOrigin(.5,.5));let s=this.getLeadCarTextureKey(t);if(!this.textures.exists(s)){this.leadCarBadge&&this.leadCarBadge.setVisible(!1);return}this.leadCarBadge?this.leadCarBadge.setTexture(s).setVisible(!0):this.leadCarBadge=this.add.image(i.x,i.y,s).setDepth(i.depth+1).setOrigin(.5,.5),this.leadCarBaseSize&&this.leadCarBadge&&this.leadCarBadge.scene&&this.leadCarBadge.setDisplaySize(.5*this.leadCarBaseSize.width,.5*this.leadCarBaseSize.height)}createLockOverlay(t,e,i,s,a){let n=this.add.container(t,e);n.setDepth(10);let r=Math.max(140,.6*i),o=Math.max(48,.35*s),l=this.add.rectangle(0,0,r,o,2042167,.9);l.setStrokeStyle(2,0xfbbf24,.9);let h=this.add.text(0,0,"UNLOCK",{fontFamily:"Arial Black",fontSize:"18px",color:"#f8fafc"}).setOrigin(.5);n.add([l,h]),n.setSize(r,o);let d=new Phaser.Geom.Rectangle(-r/2,-o/2,r,o);return n.setInteractive(d,Phaser.Geom.Rectangle.Contains),n.setData("hitArea",d),n.on("pointerover",()=>{this.quizOpen||this.gameOver||(l.setFillStyle(3359061,.95),n.setScale(1.05),this.input.setDefaultCursor("pointer"))}),n.on("pointerout",()=>{l.setFillStyle(2042167,.9),n.setScale(1),this.input.setDefaultCursor("default")}),n.on("pointerdown",()=>{this.quizOpen||this.gameOver||a===this.currentIndex&&this.openQuestion(a)}),n}refreshLocks(){this.carSlots.forEach(t=>{t&&t.car&&t.lock&&t.car.scene&&t.lock.scene&&(t.car.setAlpha(1),t.lock.setVisible(!1),t.lock.input&&t.lock.disableInteractive())});let t=Math.max(0,this.score);this.scoreText.setText("POINTS: ".concat(t.toString().padStart(2,"0")))}createQuizModal(){this.quizPanel=new f(this,{optionCount:4,depth:2e3,parent:this.uiRoot,showIndex:!0}),this.quizModal=this.quizPanel.container,this.quizPanel.onOptionSelected(t=>{this.quizLocked||this.handleAnswer(t)}),this.layoutQuiz()}createStartModal(){let{width:t,height:e}=this.scale,i=this.add.container(0,0).setDepth(2100).setVisible(!1),s=this.add.rectangle(0,0,t,e,0xffffff,.12).setOrigin(0,0),a=this.add.container(t/2,Math.round(.56*e)),n=Math.min(620,t-80),r=Math.min(220,Math.round(.32*e)),o=this.add.graphics();o.fillStyle(0,.18),o.fillRoundedRect(-n/2+8,-r/2+10,n,r,30);let l=this.add.graphics();l.fillStyle(0xffffff,.85),l.fillRoundedRect(-n/2,-r/2,n,r,28),l.lineStyle(2,0xffffff,.65),l.strokeRoundedRect(-n/2,-r/2,n,r,28);let h=this.add.text(0,-38,"Answer the questions to help the\ntrain go ahead.",{fontFamily:"Arial Black",fontSize:"20px",color:"#0f172a",align:"center",lineSpacing:6}).setOrigin(.5),d=this.createStartButton(0,Math.round(.23*r));a.add([o,l,h,d]),i.add([s,a]),this.startModal=i,this.startModalPanel=a,this.uiRoot.add(i),this.layoutStartModal()}createTimeUpModal(){let{width:t,height:e}=this.scale,i=this.add.container(0,0).setDepth(2200).setVisible(!1),s=this.add.rectangle(0,0,t,e,0,.1).setOrigin(0,0),a=this.add.container(t/2,Math.round(.56*e)),n=Math.min(620,t-80),r=Math.min(220,Math.round(.32*e)),o=this.add.graphics();o.fillStyle(0,.18),o.fillRoundedRect(-n/2+8,-r/2+10,n,r,30);let l=this.add.graphics();l.fillStyle(0xffffff,.85),l.fillRoundedRect(-n/2,-r/2,n,r,28),l.lineStyle(2,0xffffff,.65),l.strokeRoundedRect(-n/2,-r/2,n,r,28),this.timeUpTitleText=this.add.text(0,-14,"Out of time! Failed!",{fontFamily:"Arial Black",fontSize:"20px",color:"#0f172a",align:"center"}).setOrigin(.5);let h=this.createTimeoutButton(0,Math.round(.23*r));a.add([o,l,this.timeUpTitleText,h]),i.add([s,a]),this.timeUpModal=i,this.timeUpModalPanel=a,this.uiRoot.add(i),this.layoutTimeUpModal()}layoutStartModal(){if(!this.startModal||!this.startModalPanel)return;let{width:t,height:e}=this.scale,i=this.startModal.list[0];i&&"setSize"in i&&i.setSize(t,e),this.startModalPanel.setPosition(t/2,Math.round(.56*e))}layoutTimeUpModal(){if(!this.timeUpModal||!this.timeUpModalPanel)return;let{width:t,height:e}=this.scale,i=this.timeUpModal.list[0];i&&"setSize"in i&&i.setSize(t,e),this.timeUpModalPanel.setPosition(t/2,Math.round(.56*e))}createStartButton(t,e){let i=this.add.container(t,e),s=this.add.graphics();s.fillStyle(1981066,.18),s.fillRoundedRect(-261,-30,530,72,30);let a=this.add.graphics(),n=(t,e)=>{a.clear(),a.fillStyle(t,1),a.fillRoundedRect(-265,-36,530,72,30),a.lineStyle(2,e,.65),a.strokeRoundedRect(-265,-36,530,72,30)};n(3900150,9684477);let r=this.add.text(0,1,"Start Game",{fontFamily:"Arial Black",fontSize:"34px",color:"#ffffff"}).setOrigin(.5).setScale(.66),o=this.add.rectangle(0,0,546,88,0xffffff,.001);return o.setInteractive(),i.add([s,a,r,o]),i.setSize(530,72),o.on("pointerover",()=>{n(2450411,0xbfdbfe),this.input.setDefaultCursor("pointer"),this.tweens.add({targets:i,scale:1.02,duration:100,ease:"Sine.easeOut"})}),o.on("pointerout",()=>{n(3900150,9684477),this.input.setDefaultCursor("default"),this.tweens.add({targets:i,scale:1,duration:100,ease:"Sine.easeOut"})}),o.on("pointerdown",()=>{this.startModalOpen&&(n(1920728,0xbfdbfe),this.tweens.add({targets:i,scale:.98,duration:70,ease:"Sine.easeOut"}),this.startGameFlow())}),o.on("pointerup",()=>{n(2450411,0xbfdbfe),this.tweens.add({targets:i,scale:1.02,duration:70,ease:"Sine.easeOut"})}),this.tweens.add({targets:i,scale:1.03,duration:850,yoyo:!0,repeat:-1}),i}createTimeoutButton(t,e){let i=this.add.container(t,e),s=this.add.graphics();s.fillStyle(1981066,.18),s.fillRoundedRect(-261,-30,530,72,30);let a=this.add.graphics(),n=(t,e)=>{a.clear(),a.fillStyle(t,1),a.fillRoundedRect(-265,-36,530,72,30),a.lineStyle(2,e,.65),a.strokeRoundedRect(-265,-36,530,72,30)};n(3900150,9684477);let r=this.add.text(0,1,"Play Again",{fontFamily:"Arial Black",fontSize:"34px",color:"#ffffff"}).setOrigin(.5).setScale(.66),o=this.add.rectangle(0,0,546,88,0xffffff,.001);return o.setInteractive(),i.add([s,a,r,o]),i.setSize(530,72),o.on("pointerover",()=>{o.getData("restarting")||(n(2450411,0xbfdbfe),this.input.setDefaultCursor("pointer"),this.tweens.add({targets:i,scale:1.02,duration:100,ease:"Sine.easeOut"}))}),o.on("pointerout",()=>{o.getData("restarting")||(n(3900150,9684477),this.input.setDefaultCursor("default"),this.tweens.add({targets:i,scale:1,duration:100,ease:"Sine.easeOut"}))}),o.on("pointerdown",()=>{o.getData("restarting")||(o.setData("restarting",!0),o.disableInteractive(),n(1920728,0xbfdbfe),this.tweens.add({targets:i,scale:.98,duration:70,ease:"Sine.easeOut"}),this.time.delayedCall(90,()=>{this.sys.isActive()&&this.restartTrainRun()}))}),o.on("pointerup",()=>{o.getData("restarting")||(n(2450411,0xbfdbfe),this.tweens.add({targets:i,scale:1.02,duration:70,ease:"Sine.easeOut"}))}),i}openStartModal(){this.startModal&&(this.startModalOpen=!0,this.hasStarted=!1,this.startModal.setVisible(!0),this.startModal.setAlpha(0),this.tweens.add({targets:this.startModal,alpha:1,duration:180}))}closeStartModal(){this.startModal&&(this.startModalOpen=!1,this.startModal.setVisible(!1))}startGameFlow(){this.hasStarted||(this.hasStarted=!0,this.closeStartModal(),this.openQuestion(this.currentIndex))}openTimeUpModal(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Out of time! Try again.";this.timeUpModal&&this.timeUpModalPanel&&(this.timeUpTitleText.setText(t),this.timeUpModalPanel.setScale(.96),this.timeUpModal.setVisible(!0),this.timeUpModal.setAlpha(0),this.tweens.add({targets:this.timeUpModal,alpha:1,duration:200}),this.tweens.add({targets:this.timeUpModalPanel,scale:1,duration:240,ease:"Back.easeOut"}))}submitSessionResult(){this.sessionGameId&&Promise.resolve().then(i.bind(i,143)).then(t=>{let{endGameSession:e}=t;return e(this.sessionGameId,this.score)}).catch(t=>{console.error("endGameSession failed",t)})}restartTrainRun(){this.sys&&this.sys.isActive()&&(this.input.setDefaultCursor("default"),this.closeQuiz(),this.timeUpModal&&this.timeUpModal.setVisible(!1),this.scene.restart({gameCode:this.gameCode,sessionId:this.sessionId,gameId:this.sessionGameId,questions:this.sessionQuestions,timeLimit:this.sessionTimeLimit}))}layoutQuiz(){let{width:t,height:e}=this.scale;this.quizPanel.layout(t,e)}openQuestion(t){var e;if(this.quizOpen||this.gameOver||!this.hasStarted)return;this.setLeadCarState("idle");let i=this.getQuestionForIndex(t),s=i.question.options.map(t=>t.text);this.currentOptionIds=i.question.options.map(t=>{var e;return null!=(e=t.id)?e:""}),this.currentSessionQuestionId=null!=(e=i.session_question_id)?e:null;let a=i.question.options.findIndex(t=>t.is_correct);a<0&&(a=0),this.currentCorrectIndex=a,this.quizPanel.setFeedback("idle"),this.quizPanel.setQuestion({index:t+1,total:this.maxCars,question:i.question.content,options:s}),this.updateBarrierPosition(),this.setBarrierOpen(!1),this.layoutQuiz(),this.quizOpen=!0,this.quizLocked=!1,this.quizModal.setVisible(!0),this.quizPanel.setInteractive(!0)}async handleAnswer(t){if(this.quizLocked)return;this.quizLocked=!0;let e=t===this.currentCorrectIndex,s=this.currentOptionIds[t];if(this.sessionId&&this.currentSessionQuestionId&&s)try{let{submitAnswer:t}=await Promise.resolve().then(i.bind(i,143));e=(await t(this.sessionId,this.currentSessionQuestionId,s)).data.is_correct}catch(t){console.error("submitAnswer failed, fallback to local check",t)}e?(this.setLeadCarState("correct"),this.quizPanel.setFeedback("correct"),this.quizPanel.setOptionState(t,"correct"),this.quizPanel.setInteractive(!1),this.time.delayedCall(500,()=>{this.closeQuiz(),this.applyCorrect()})):(this.setLeadCarState("incorrect"),this.quizPanel.setFeedback("wrong"),this.quizPanel.setOptionState(t,"wrong"),this.quizPanel.setInteractive(!1),this.time.delayedCall(650,()=>{this.applyWrong(),this.setLeadCarState("idle"),this.quizPanel.setOptionState(t,"normal"),this.quizPanel.setFeedback("idle"),this.quizPanel.setInteractive(!0),this.quizLocked=!1}))}applyCorrect(){if(this.currentIndex=Math.min(this.maxCars,this.currentIndex+1),this.score=this.currentIndex,this.refreshLocks(),this.currentIndex>=this.maxCars){this.setBarrierOpen(!0),this.moveTrainToEnd(()=>{this.endGame("You completed all ".concat(this.maxCars," cars!"),"win")});return}this.moveTrainToIndex(this.currentIndex,()=>{this.openQuestion(this.currentIndex)})}applyWrong(){this.refreshLocks()}moveTrainToIndex(t,e){if(this.railTotalLength<=0||this.trainStepPx<=0){e&&e();return}let i=Phaser.Math.Clamp(t,0,this.maxCars),s=Math.max(0,this.railTotalLength-1),a=Math.min(this.trainStepPx*i,s),n=Math.abs(a-this.trainDistancePx),r=Phaser.Math.Clamp(Math.round(420+1.8*n),650,1200);this.trainMoving=!0;let o={value:this.trainDistancePx};this.tweens.add({targets:o,value:a,duration:r,ease:"Sine.easeInOut",onUpdate:()=>{this.trainDistancePx=o.value,this.updateTrainCars(!0)},onComplete:()=>{this.trainDistancePx=a,this.trainMoving=!1,this.updateTrainCars(!0),e&&e()}})}moveTrainToEnd(t){if(this.railTotalLength<=0){t&&t();return}let e=Math.max(0,this.railTotalLength-1)+Math.max(0,(this.maxCars-1)*this.trainGapPx),i=Math.abs(e-this.trainDistancePx),s=Phaser.Math.Clamp(Math.round(520+1.6*i),800,1800);this.trainMoving=!0;let a={value:this.trainDistancePx};this.tweens.add({targets:a,value:e,duration:s,ease:"Sine.easeInOut",onUpdate:()=>{this.trainDistancePx=a.value,this.updateTrainCars(!0)},onComplete:()=>{this.trainDistancePx=e,this.trainMoving=!1,this.updateTrainCars(!0),t&&t()}})}closeQuiz(){this.quizModal.setVisible(!1),this.quizOpen=!1,this.quizLocked=!1}getQuestionForIndex(t){return 0===this.questions.length?S[0]:this.questions[t%this.questions.length]}createTrackCurve(t,e){let i=t/750,s=e/1334,a=[{x:405,y:10},{x:455,y:85},{x:515,y:200},{x:485,y:360},{x:375,y:540},{x:250,y:740},{x:220,y:920},{x:270,y:1100},{x:325,y:1185},{x:505,y:1325}].map(t=>new Phaser.Math.Vector2(t.x*i,t.y*s));return new Phaser.Curves.Spline(a)}sampleTrack(t,e){let i=[],s=Math.max(1,e-1);for(let a=0;a<e;a+=1){let e=0===s?0:a/s,n=t.getPointAt(e);i.push({x:n.x,y:n.y})}return i}drawTrackCurve(t){let{startT:e,endT:i}=this.getVisibleTRange(t),s=this.add.graphics();s.setDepth(1e3),s.lineStyle(10,0xff0000,1);let a=t.getPoint(e);s.beginPath(),s.moveTo(a.x,a.y);for(let a=1;a<=120;a+=1){let n=e+a/120*(i-e),r=t.getPoint(n);s.lineTo(r.x,r.y)}s.strokePath(),this.debugCurveGraphics=s}drawCurveMarkers(t,e){let{width:i,height:s}=this.scale,{startT:a,endT:n}=this.getVisibleTRange(t),r=this.add.graphics();r.setDepth(1001),r.fillStyle(2278750,1),r.lineStyle(2,2278750,1);let o=Math.max(1,e-1);for(let l=0;l<e;l+=1){let e=0===o?a:a+l/o*(n-a),h=t.getPoint(e),d=Phaser.Math.Clamp(h.x,16,i-16),c=Phaser.Math.Clamp(h.y,16,s-16);(d!==h.x||c!==h.y)&&r.strokeLineShape(new Phaser.Geom.Line(h.x,h.y,d,c)),r.fillCircle(d,c,8);let u="".concat(l+1," (").concat(Math.round(h.x),", ").concat(Math.round(h.y),")"),g=this.add.text(d+10,c-10,u,{fontFamily:"Arial Black",fontSize:"18px",color:"#22c55e",stroke:"#0f172a",strokeThickness:3});g.setDepth(1002),this.debugMarkerLabels.push(g)}this.debugMarkerGraphics=r}getVisibleTRange(t){let{width:e,height:i}=this.scale,s=0,a=1,n=!1;for(let r=0;r<=400;r+=1){let o=r/400,l=t.getPoint(o),h=l.x>=8&&l.x<=e-8&&l.y>=8&&l.y<=i-8;h&&!n&&(s=o,n=!0),h&&(a=o)}return{startT:Math.max(0,s-0),endT:Math.min(1,a+0)}}getTrackAngle(t,e){var i,s;let a=t[e],n=null!=(s=null!=(i=t[e+1])?i:t[e-1])?s:a;return Math.atan2(n.y-a.y,n.x-a.x)}buildRailPath(t){let e=Math.max(60,Math.round(t.getLength()/20)),i=[];for(let s=0;s<=e;s+=1){let a=s/e,n=t.getPointAt(a);i.push(new Phaser.Math.Vector2(n.x,n.y))}if(i.length<2){this.railPathPoints=i,this.railSegmentLengths=[],this.railTotalLength=0;return}let s=[],a=0;for(let t=0;t<i.length-1;t+=1){let e=i[t],n=i[t+1],r=Phaser.Math.Distance.Between(e.x,e.y,n.x,n.y);s.push(r),a+=r}this.railPathPoints=i,this.railSegmentLengths=s,this.railTotalLength=a}sampleRailByDistanceNoWrap(t){if(this.railPathPoints.length<2||this.railTotalLength<=0)return{position:new Phaser.Math.Vector2(0,0),angle:0};let e=this.railTotalLength;if(t<=0){let e=this.railPathPoints[0],i=this.railPathPoints[1],s=Math.atan2(i.y-e.y,i.x-e.x),a=new Phaser.Math.Vector2(Math.cos(s),Math.sin(s));return{position:new Phaser.Math.Vector2(e.x,e.y).add(a.scale(t)),angle:s}}if(t>=e){let i=this.railPathPoints[this.railPathPoints.length-1],s=this.railPathPoints[this.railPathPoints.length-2],a=Math.atan2(i.y-s.y,i.x-s.x),n=new Phaser.Math.Vector2(Math.cos(a),Math.sin(a));return{position:new Phaser.Math.Vector2(i.x,i.y).add(n.scale(t-e)),angle:a}}let i=t,s=0;for(;s<this.railSegmentLengths.length&&i>this.railSegmentLengths[s];)i-=this.railSegmentLengths[s],s+=1;let a=Math.min(s,this.railPathPoints.length-2),n=this.railPathPoints[a],r=this.railPathPoints[a+1],o=this.railSegmentLengths[a]||1,l=Phaser.Math.Clamp(i/o,0,1),h=Phaser.Math.Linear(n.x,r.x,l),d=Phaser.Math.Linear(n.y,r.y,l),c=Math.atan2(r.y-n.y,r.x-n.x);return{position:new Phaser.Math.Vector2(h,d),angle:c}}createRailway(){let{width:t,height:e}=this.scale,i=this.createTrackCurve(t,e);this.trackSpline=i,this.trackLength=i.getLength(),this.buildRailPath(i);let s=Math.min(t/750,e/1334),a=18*s,n=1.8*a,r=7*s,o=this.add.container(0,0);this.railwayContainer=o;let l=[],h=[];for(let t=0;t<=140;t+=1){let e=t/140,s=i.getPoint(e),n=i.getTangent(e).normalize(),r=new Phaser.Math.Vector2(-n.y,n.x).normalize();l.push(new Phaser.Math.Vector2(s.x+r.x*a,s.y+r.y*a)),h.push(new Phaser.Math.Vector2(s.x-r.x*a,s.y-r.y*a))}let d=this.add.graphics();d.lineStyle(8*s,0xf8fafc,1),d.beginPath(),d.moveTo(l[0].x,l[0].y),l.forEach(t=>d.lineTo(t.x,t.y)),d.strokePath(),d.beginPath(),d.moveTo(h[0].x,h[0].y),h.forEach(t=>d.lineTo(t.x,t.y)),d.strokePath(),d.setDepth(5),o.add(d);for(let t=0;t<=28;t+=1){let e=t/28,s=i.getPoint(e),a=i.getTangent(e).normalize(),l=Math.atan2(a.y,a.x)+Math.PI/2,h=this.add.rectangle(s.x,s.y,n,r,0xb45309,.95);h.setRotation(l),h.setDepth(4),o.add(h)}this.debugTrack&&(this.drawTrackCurve(i),this.drawCurveMarkers(i,11)),this.setRailwayVisible(this.showRailOverlay),this.setDebugTrackVisible(this.debugTrack),this.trainDistancePx=0,this.trainStepPx<=0&&(this.trainStepPx=this.railTotalLength>1?(this.railTotalLength-1)/this.maxCars:0),this.refreshLocks(),this.updateTrainCars(!0)}createBarrierGate(){if(!this.textures.exists("train-barrier"))return;let t=this.add.image(0,0,"train-barrier");t.setDepth(6),t.setOrigin(.08,.5),this.barrierGate=t,this.updateBarrierPosition(),this.setBarrierOpen(!1,!0)}updateBarrierPosition(){if(!this.barrierGate)return;let t=this.scale.width/750,e=this.scale.height/1334;this.barrierGate.setPosition(355*t,230*e);let i=.35*Math.min(t,e);this.barrierGate.setScale(i),this.barrierBaseAngle=0;let s=this.barrierIsOpen?this.barrierBaseAngle-Phaser.Math.DegToRad(45):this.barrierBaseAngle;this.barrierGate.setRotation(s)}setBarrierOpen(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.barrierGate)return;this.barrierIsOpen=t;let i=t?this.barrierBaseAngle-Phaser.Math.DegToRad(45):this.barrierBaseAngle;if(e)return void this.barrierGate.setRotation(i);this.tweens.add({targets:this.barrierGate,rotation:i,duration:220,ease:"Sine.easeInOut"})}updateTrainCars(){var t;let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.showCars||!e&&!this.trainMoving||this.railTotalLength<=0)return;for(let t=0;t<this.carSlots.length;t+=1){let e=this.carSlots[t],i=this.trainDistancePx-t*this.trainGapPx,s=Math.max(0,this.railTotalLength-1)-i,a=this.sampleRailByDistanceNoWrap(s);e.car.setPosition(a.position.x,a.position.y),e.car.setRotation(a.angle+this.trainRotationOffset)}let i=null==(t=this.carSlots[0])?void 0:t.car;if(i&&this.leadCarBadge&&this.leadCarBadge.scene){let t=-(.34*i.displayWidth),e=-(.08*i.displayHeight),s=i.rotation,a=i.x+Math.cos(s)*t-Math.sin(s)*e,n=i.y+Math.sin(s)*t+Math.cos(s)*e;this.leadCarBadge.setPosition(a,n),this.leadCarBadge.setRotation(s)}}setShowCars(t){this.showCars=t,this.carSlots.forEach(e=>{e.car.setVisible(t),e.lock.setVisible(!1)}),this.leadCarBadge&&this.leadCarBadge.setVisible(t),t&&(this.refreshLocks(),this.updateTrainCars(!0))}setRailwayVisible(t){this.railwayContainer&&this.railwayContainer.setVisible(t),this.debugCurveGraphics&&this.debugCurveGraphics.setVisible(t&&this.debugTrack),this.debugMarkerGraphics&&this.debugMarkerGraphics.setVisible(t&&this.debugTrack),this.debugMarkerLabels.forEach(e=>e.setVisible(t&&this.debugTrack))}isRailwayVisible(){var t,e;return null==(e=null==(t=this.railwayContainer)?void 0:t.visible)||e}setDebugTrackVisible(t){this.debugTrack=t,this.debugCurveGraphics&&this.debugCurveGraphics.setVisible(t),this.debugMarkerGraphics&&this.debugMarkerGraphics.setVisible(t),this.debugMarkerLabels.forEach(e=>e.setVisible(t))}setTrainMoving(t){this.trainMoving=t,t||this.updateTrainCars(!0)}endGame(t,e){if(!this.gameOver){if(this.gameOver=!0,this.quizOpen=!1,this.quizLocked=!1,this.hasStarted=!1,this.closeQuiz(),this.submitSessionResult(),"lose"===e)return void this.openTimeUpModal("Out of time! Try again.");this.openTimeUpModal(t||"Great job! You won!")}}formatTime(t){let e=Math.floor(t/60);return"".concat(e,"m ").concat((t%60).toString().padStart(2,"0"),"s")}constructor(){super("TrainGame"),this.debugTrack=!1,this.showRailOverlay=!1,this.showCars=!0,this.trainMoving=!1,this.trafficLightState=null,this.trainDistancePx=0,this.trainSpeedPxPerSec=-180,this.trainGapPx=0,this.trackLength=0,this.trainCarGapFactor=.68,this.trainCarScaleFactor=.468,this.railPathPoints=[],this.railSegmentLengths=[],this.railTotalLength=0,this.trainRotationOffset=Phaser.Math.DegToRad(-90),this.leadCarState="idle",this.leadCarBaseSize=null,this.debugMarkerLabels=[],this.showHoverCoords=!1,this.barrierBaseAngle=0,this.barrierIsOpen=!1,this.carSlots=[],this.startModalOpen=!1,this.hasStarted=!1,this.gameCode="train_game",this.sessionId=null,this.sessionGameId=null,this.sessionQuestions=null,this.sessionTimeLimit=null,this.maxCars=11,this.currentIndex=0,this.score=0,this.totalTimeMs=3e5,this.remainingMs=3e5,this.lastSecondShown=-1,this.quizOpen=!1,this.quizLocked=!1,this.gameOver=!1,this.questions=[],this.currentCorrectIndex=0,this.currentSessionQuestionId=null,this.currentOptionIds=[],this.trainStepPx=0}}var T=i(2408);class b extends n.Scene{init(t){var e;this.gameCode=h(null!=(e=null==t?void 0:t.gameCode)?e:this.registry.get("gameCode")),this.registry.set("gameCode",this.gameCode)}create(){let{width:t,height:e}=this.scale,i=d(this.gameCode);this.background=this.add.image(t/2,e/2,i.mapKey).setDisplaySize(t,e),this.logo=this.add.image(t/2,220,"logo").setDepth(100).setScale(.9),this.title=this.add.text(t/2,360,i.label,{fontFamily:"Arial Black",fontSize:46,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5).setDepth(100),this.description=this.add.text(t/2,460,"Nhấn n\xfat NEXT để nhảy!\nĐạt điểm cao nhất c\xf3 thể!",{fontFamily:"Arial",fontSize:28,color:"#e2e8f0",align:"center",wordWrap:{width:600}}).setOrigin(.5).setDepth(100),this.debugText=this.add.text(t/2,660,"DEBUG: ready | token=static (".concat("env_debug_token",")"),{fontFamily:"Arial",fontSize:16,color:"#f8fafc",align:"center",wordWrap:{width:640}}).setOrigin(.5).setDepth(120),this.startButton=this.createButton(t/2,590,"Bắt đầu"),"vocab_race"===i.code&&(this.debugText.setText("DEBUG: preflight -> calling /game/list-game ..."),(0,g.fetchGameList)({forceReal:!0}).then(t=>{var e,i,s,a;console.error("[GAME][PREFLIGHT] list-game success",{count:null!=(s=null==(e=t.data)?void 0:e.length)?s:0}),this.debugText.setText("DEBUG: preflight success | list=".concat(null!=(a=null==(i=t.data)?void 0:i.length)?a:0))}).catch(t=>{let e=t instanceof Error?t.message:String(t);console.error("[GAME][PREFLIGHT] list-game failed",{error:e}),this.debugText.setText("DEBUG: preflight failed | ".concat(e))})),u.emit("current-scene-ready",this)}createButton(t,e,i){let s=this.add.container(t,e),a=this.add.rectangle(0,0,300,80,2042167).setStrokeStyle(3,3718648),n=this.add.text(0,0,i,{fontFamily:"Arial Black",fontSize:32,color:"#f8fafc"}).setOrigin(.5);return s.add([a,n]),s.setSize(300,80),s.setInteractive(new Phaser.Geom.Rectangle(-150,-40,300,80),Phaser.Geom.Rectangle.Contains),s.on("pointerover",()=>{a.setFillStyle(3359061),s.setScale(1.1),this.input.setDefaultCursor("pointer")}),s.on("pointerout",()=>{a.setFillStyle(2042167),s.setScale(1),this.input.setDefaultCursor("default")}),s.on("pointerdown",()=>{this.isStarting||(s.setScale(.95),this.time.delayedCall(100,()=>this.changeScene()))}),s}changeScene(){if(this.isStarting)return;this.isStarting=!0,this.startButton.setAlpha(.6),console.log("[GAME][SESSION] Start button clicked",{gameCode:this.gameCode}),this.debugText.setText("DEBUG: start clicked -> calling startGameSession...");let t=d(this.gameCode),e="vocab_race"===t.code;(0,g.startGameSession)(t.code,{forceReal:e}).then(i=>{var s,a,n,r,o,l;let h=i.data;console.log("[GAME][SESSION] startGameSession success",{gameCode:this.gameCode,apiMode:(0,T.YY)(),forceReal:e,sessionId:h.id,gameId:h.game_id,questionCount:null!=(r=null==(s=h.questions)?void 0:s.length)?r:0,timeLimit:null!=(o=null==(a=h.game)?void 0:a.time_limit)?o:null}),this.debugText.setText("DEBUG: API success | questions=".concat(null!=(l=null==(n=h.questions)?void 0:n.length)?l:0));let d="train_game"===t.code?"TrainGame":"Game";this.scene.start(d,{gameCode:this.gameCode,sessionId:h.id,gameId:h.game_id,questions:h.questions,timeLimit:h.game.time_limit})}).catch(i=>{console.error("[GAME][SESSION] startGameSession failed, fallback to local questions",{gameCode:this.gameCode,apiMode:(0,T.YY)(),forceReal:e,error:i});let s=i instanceof Error?i.message:String(i);if(this.debugText.setText("DEBUG: API failed -> ".concat(s)),e)return void this.description.setText("Kh\xf4ng lấy được c\xe2u hỏi từ REAL API.\nKiểm tra token/API rồi thử lại.");let a="train_game"===t.code?"TrainGame":"Game";this.scene.start(a,{gameCode:this.gameCode,sessionId:null,gameId:null,questions:null,timeLimit:null})}).finally(()=>{this.isStarting=!1,this.startButton.setAlpha(1)})}constructor(){super("MainMenu"),this.isStarting=!1,this.gameCode="vocab_race"}}class M extends n.Scene{init(){let{width:t,height:e}=this.cameras.main,i=t/2,s=e/2;this.createParallaxLoaderBackground(),this.add.image(i,s-120,"logo").setScale(.8),this.add.text(i,s-40,"Loading Game...",{fontFamily:"Arial",fontSize:"24px",color:"#ffffff",stroke:"#000000",strokeThickness:4}).setOrigin(.5);let a=i-200,n=s+20;this.add.rectangle(i,n+12,404,28,0,.5),this.add.rectangle(i,n+12,400,24).setStrokeStyle(2,0xffffff),this.progressBar=this.add.rectangle(a+2,n+2,0,20,65416),this.progressBar.setOrigin(0,0),this.progressText=this.add.text(i,n+12,"0%",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5),this.statusText=this.add.text(i,n+24+20,"",{fontFamily:"Arial",fontSize:"14px",color:"#cccccc"}).setOrigin(.5),this.load.on("progress",t=>{this.progressBar.width=396*t,this.progressText.setText("".concat(Math.round(100*t),"%"))}),this.load.on("load",t=>{this.statusText.setText("Loading: ".concat(t.key))}),this.load.on("loaderror",t=>{this.loadErrors.push(t.key),console.warn("Failed to load: ".concat(t.key)),this.statusText.setText("Error loading: ".concat(t.key)),this.statusText.setColor("#ff6666")})}update(){if(!this.parallaxLayers.length)return;let t=this.time.now;this.parallaxLayers.forEach(e=>{let i=e.getData("speed");e.tilePositionY=t*i})}preload(){let t=d(this.registry.get("gameCode")),e=t.assetRoot;if(this.load.setPath("/assets"),"train_game"===t.code){this.load.image("star","games/tower/ui/star.png"),this.load.image("train-bg","".concat(e,"/background copy 2.png")),this.load.image("train-engine","".concat(e,"/train.png")),this.load.image("train-light","".concat(e,"/light.png")),this.load.image("train-light-red","".concat(e,"/Fox and Traffic light/Red.png")),this.load.image("train-light-yellow","".concat(e,"/Fox and Traffic light/Yellow.png")),this.load.image("train-light-green","".concat(e,"/Fox and Traffic light/Green.png")),this.load.image("train-fox-idle","".concat(e,"/Fox and Traffic light/Idle.png")),this.load.image("train-fox-correct","".concat(e,"/Fox and Traffic light/Correct.png")),this.load.image("train-fox-incorrect","".concat(e,"/Fox and Traffic light/Incorrect.png")),this.load.image("train-barrier","".concat(e,"/s.png"));for(let t=1;t<=11;t+=1)this.load.image("train-car-".concat(t),"".concat(e,"/Train/").concat(t,".png"));this.load.image(t.mapKey,"".concat(e,"/").concat(t.mapPath))}else this.load.image("star","".concat(e,"/ui/star.png")),this.load.image("ui-example","".concat(e,"/ui/example.png")),this.load.image("bg-1","".concat(e,"/backgrounds/1.png")),this.load.image("bg-2","".concat(e,"/backgrounds/2.png")),this.load.image("bg-3","".concat(e,"/backgrounds/3.png")),this.load.image("bg-4","".concat(e,"/backgrounds/4.png")),this.load.image("bg-5","".concat(e,"/backgrounds/5.png")),this.load.image("bg-6","".concat(e,"/backgrounds/6.png")),this.load.image(t.mapKey,"".concat(e,"/").concat(t.mapPath)),this.load.spritesheet("character","".concat(e,"/characters/character animation tran.png"),{frameWidth:515,frameHeight:1128,margin:15}),this.load.image("char-emotes","".concat(e,"/characters/char-emotes.png")),this.load.image("emote-tran-idle","".concat(e,"/emotes/emo tran .png")),this.load.image("emote-tran-idle-flipped","".concat(e,"/emotes/emo tran flipped idle.png")),this.load.image("emote-tran-correct","".concat(e,"/emotes/emo tran correct.png")),this.load.image("emote-tran-correct-flipped","".concat(e,"/emotes/emo tran flipped correct.png")),this.load.image("emote-tran-incorrect","".concat(e,"/emotes/emo tran incorrect.png")),this.load.image("emote-tran-incorrect-flipped","".concat(e,"/emotes/emo tran flipped incorrect.png")),this.load.image("tile-1","".concat(e,"/tiles/1.png")),this.load.image("tile-2","".concat(e,"/tiles/2.png")),this.load.image("tile-3","".concat(e,"/tiles/3.png")),this.load.image("tile-4","".concat(e,"/tiles/4.png")),this.load.image("tile-5","".concat(e,"/tiles/5.png")),this.load.image("tile-6","".concat(e,"/tiles/6.png")),this.load.image("tile-flower","".concat(e,"/tiles/flower.png")),this.load.image("tile-green","".concat(e,"/tiles/green.png")),this.load.image("tile-shadow","".concat(e,"/tiles/shadoe.png")),this.load.image("map-all","".concat(e,"/maps/All map.png"))}createParallaxLoaderBackground(){let{width:t,height:e}=this.cameras.main,i=[.01,.02,.03,.04,.055,.07];this.parallaxLayers=["bg-1","bg-2","bg-3","bg-4","bg-5","bg-6"].map((s,a)=>{let n=this.add.tileSprite(0,0,t,e,s).setOrigin(0,0).setScrollFactor(0).setDepth(-100+a);return n.setData("speed",i[a]),n})}create(){this.loadErrors.length>0&&console.warn("Assets failed to load:",this.loadErrors);let t=this.registry.get("gameCode");"train_game"!==d(t).code&&this.createGlobalAnimations(),this.time.delayedCall(300,()=>{this.cameras.main.fadeOut(200,0,0,0),this.cameras.main.once("camerafadeoutcomplete",()=>{"train_game"===d(t).code?this.scene.start("TrainGame",{gameCode:t}):this.scene.start("Game",{gameCode:t})})})}createGlobalAnimations(){this.anims.create({key:"character-fly",frames:this.anims.generateFrameNumbers("character",{start:0,end:9}),frameRate:10,repeat:-1}),this.anims.create({key:"tran-jump",frames:this.anims.generateFrameNumbers("character",{start:0,end:4}),frameRate:6,repeat:-1})}constructor(){super("Preloader"),this.loadErrors=[],this.parallaxLayers=[]}}let P={type:n.AUTO,parent:"game-container",backgroundColor:"#3fb3e8",scale:{mode:r().Scale.FIT,autoCenter:r().Scale.CENTER_BOTH,width:720,height:1280},scene:[c,M,b,x,y,p]},k=(0,a.forwardRef)(function(t,e){let{currentActiveScene:i,gameCode:r}=t,o=(0,a.useRef)(null);return(0,a.useLayoutEffect)(()=>(null===o.current&&(o.current=((t,e)=>{var i;let s=h(null!=(i=null==e?void 0:e.gameCode)?i:l);return new n.Game({...P,parent:t,callbacks:{preBoot:t=>{t.registry.set("gameCode",s)}}})})("game-container",{gameCode:r}),"function"==typeof e?e({game:o.current,scene:null}):e&&(e.current={game:o.current,scene:null})),()=>{o.current&&(o.current.destroy(!0),null!==o.current&&(o.current=null))}),[e]),(0,a.useEffect)(()=>(u.on("current-scene-ready",t=>{i&&"function"==typeof i&&i(t),"function"==typeof e?e({game:o.current,scene:t}):e&&(e.current={game:o.current,scene:t})}),()=>{u.removeListener("current-scene-ready")}),[i,e]),(0,s.jsx)("div",{id:"game-container"})}),C=function(t){let{gameCode:e}=t;return(0,s.jsx)("div",{id:"app",children:(0,s.jsx)(k,{gameCode:e})})}}}]);